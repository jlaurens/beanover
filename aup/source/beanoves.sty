%%
%% This is file `beanoves.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% beanoves.dtx  (with options: `package,final')
%% 

\NeedsTeXFormat{LaTeX2e}[2020/01/01]
\ProvidesExplPackage
  {beanoves}
  {2023/01/07}
  {1.0}
  {Named overlay specifications for beamer}
\msg_new:nnn { beanoves } { :n } { #1 }
\msg_new:nnn { beanoves } { :nn } { #1~(#2) }
\cs_new:Npn \BNVS_warning:n {
  \msg_warning:nnn { beanoves } { :n }
}
\cs_generate_variant:Nn \BNVS_warning:n { x }
\cs_new:Npn \BNVS_error:n {
  \msg_error:nnn { beanoves } { :n }
}
\cs_new:Npn \BNVS_error:x {
  \msg_error:nnx { beanoves } { :n }
}
\cs_new:Npn \BNVS_fatal:n {
  \msg_fatal:nnn { beanoves } { :n }
}
\cs_new:Npn \BNVS_fatal:x {
  \msg_fatal:nnx { beanoves } { :n }
}
\cs_generate_variant:Nn \BNVS_log:n { x }
\cs_new:Npn \BNVS_log:N #1 { \BNVS_log:x { \token_to_str:N #1 } }
\cs_new:Npn \BNVS_DEBUG_on: {
  \cs_set:Npn \BNVS_log:n { \BNVS_DEBUG_log:n }
}
\cs_new:Npn \BNVS_DEBUG_off: {
  \cs_set:Npn \BNVS_log:n { \use_none:n }
}
\BNVS_DEBUG_on:
\cs_new:Npn \BNVS_c:b    #1    { BNVS_#1     }
\cs_new:Npn \BNVS_l_c:ti #1 #2 { l__bnvs_#2_#1 }
\cs_new:Npn \BNVS_g_c:ti #1 #2 { g__bnvs_#2_#1 }
\cs_new:Npn \BNVS_c_c:ti #1 #2 { c__bnvs_#2_#1 }
\cs_new:Npn \BNVS_use:N #1 { #1 }
\cs_generate_variant:Nn \BNVS_use:N { c }
\cs_new:Npn \BNVS_use:b #1 {
  \BNVS_use:c { \BNVS_c:b { #1 } }
}
\cs_new:Npn \BNVS_new:bpn #1 {
  \cs_new:cpn { \BNVS_c:b { #1 } }
}
\cs_new:Npn \BNVS_set:bpn #1 {
  \cs_set:cpn { \BNVS_c:b { #1 } }
}
\cs_generate_variant:Nn \cs_generate_variant:Nn { c }
\cs_new:Npn \BNVS_generate_variant:bn #1 {
  \cs_generate_variant:cn { \BNVS_c:b { #1 } }
}
\cs_new:Npn \BNVS_use_signed:nN #1 {}
\cs_generate_variant:Nn \BNVS_use_signed:nN { nc }
\cs_new:Npn \BNVS_use_signed:nb #1 #2 { \BNVS_use_signed:nc { #1 } { \BNVS_c:b { #2 } } }
\cs_new:Npn \BNVS_use_head_signed:nN #1 {}
\cs_generate_variant:Nn \BNVS_use_head_signed:nN { nc }
\cs_new:Npn \BNVS_use_head_signed:nb #1 #2 { \BNVS_use_head_signed:nc { #1 } { \BNVS_c:b { #2 } } }
\quark_new:N \q__bnvs
\cs_new:Npn \BNVS_use:NN #1 #2 {
  #1 #2
}
\cs_new:Npn \BNVS_use:NV #1 #2 {
  #1 #2
}
\cs_generate_variant:Nn \BNVS_use:NN { Nc }
\cs_new:Npn \BNVS_use:Nb #1 #2 {
  \BNVS_use:Nc #1 { \BNVS_c:b { #2 } }
}
\cs_new:Npn \BNVS_use:nN #1 #2 {
  #1 #2
}
\cs_new:Npn \BNVS_use:nV #1 #2 {
  #1 #2
}
\cs_generate_variant:Nn \BNVS_use:nN { nc }
\cs_new:Npn \BNVS_use:nb #1 #2 {
  \BNVS_use:nc { #1 } { \BNVS_c:b { #2 } }
}
\cs_new:Npn \BNVS_use:ti #1 #2 {
  \use:c { \BNVS_l_c:ti #1 #2 }
}
\cs_new:Npn \BNVS_use_n:nti #1 #2 #3 {
  \exp_args:Nnv \use:n { #1 } { \BNVS_l_c:ti { #2 } { #3 } }
}
\cs_new:Npn \BNVS_use_N:nti #1 #2 #3 {
  \exp_args:Nnc \use:n { #1 } { \BNVS_l_c:ti { #2 } { #3 } }
}
\cs_new:Npn \BNVS_use_V:nti #1 #2 #3 {
  \exp_args:Nnv \use:n { #1 } { \BNVS_l_c:ti { #2 } { #3 } }
}

\cs_new:Npn \BNVS_kit_new:t #1 {
  \cs_new:cpn { BNVS_#1_l_c:i } ##1 {
    l \BNVS_c:b{ ##1 } \tl_if_empty:nF { ##1 } { _ } #1
  }
  \cs_new:cpn { BNVS_#1_new:i } ##1 {
    \use:c { #1_new:c } { \BNVS_l_c:ti { #1 } { ##1 } }
  }
}
\exp_args_generate:n { nNc }
\cs_new:Npn \BNVS_kit_use:t #1 {
  \BNVS_new:bpn { #1_use:i } ##1 {
    \use:c { #1_use:c } { \BNVS_l_c:ti { #1 } { ##1 } }
  }
  \BNVS_new:bpn { #1_use_n:Ni } ##1 ##2 {
    \exp_args:NNnc\exp_args:NnV
    \use:n {
      \BNVS_use_head_signed:nN {n} ##1
    } { \BNVS_l_c:ti { #1 } { ##2 } }
  }
  \BNVS_new:bpn { #1_use_N:Ni } ##1 ##2 {
    \exp_args:NnNc
    \BNVS_use_head_signed:nN {N} ##1 {
      \BNVS_l_c:ti { #1 } { ##2 }
    }
  }
  \BNVS_new:bpn { #1_use_V:Ni } ##1 ##2 {
    \exp_args:NnNc
    \BNVS_use_head_signed:nN {V} ##1 {
      \BNVS_l_c:ti { #1 } { ##2 }
    }
  }
  \BNVS_new:bpn { #1_use_n:ni } ##1 ##2 {
    \exp_args:NNnc \exp_args:NnV \use:n { ##1 } { \BNVS_l_c:ti { #1 } { ##2 } }
  }
  \BNVS_new:bpn { #1_use_N:ni } ##1 ##2 {
    \exp_args:Nnc \use:n { ##1 } { \BNVS_l_c:ti { #1 } { ##2 } }
  }
  \BNVS_new:bpn { #1_use_V:ni } ##1 ##2 {
    \exp_args:NNnc \exp_args:NnV \use:n { ##1 } { \BNVS_l_c:ti { #1 } { ##2 } }
  }
}
\BNVS_kit_new:t { bool }
\BNVS_kit_use:t { bool }
\BNVS_kit_new:t { int }
\BNVS_kit_use:t { int }
\BNVS_kit_new:t { tl }
\BNVS_kit_use:t { tl }
\BNVS_kit_new:t { str }
\BNVS_kit_use:t { str }
\BNVS_kit_new:t { seq }
\BNVS_kit_use:t { seq }
\cs_undefine:N \BNVS_kit_new:t
\cs_undefine:N \BNVS_kit_use:t
\BNVS_new:bpn { seq_use:Nin } #1 #2 #3 {
  \exp_args:NNx \BNVS_use:Nn #1 { \BNVS_seq_use:in { #2 } { #3 } }
}
\BNVS_new:bpn { seq_use:cin } #1 {
  \exp_args:Nc \BNVS_seq_use:Nin { #1 }
}
\BNVS_new:bpn { seq_use:bin } #1 {
  \BNVS_seq_use:cin { \BNVS_seq_use:in { #1 } }
}
\BNVS_new:bpn { seq_use:nin } #1 #2 #3 {
  \exp_args:Nnx \use:n { #1 } { \BNVS_seq_use:in { #2 } { #3 } }
}
\BNVS_new:bpn { seq_use_flat:i } #1 {
  \BNVS_seq_use_n:in { #1 } { \q__bnvs }
}
\BNVS_new:bpn { seq_set_from_flat:in } #1 #2 {
  \BNVS_seq_set_split:inn { #1 } { \q__bnvs } { #2 }
  \BNVS_seq_remove_all:in { #1 } {}
}
\BNVS_new:bpn { seq_merge:ii } #1 #2 {
  \BNVS_seq_if_empty:iF { #2 } {
    \exp_args:Nnx
    \BNVS_seq_set_from_flat:in { #1 } {
      \BNVS_seq_use:in { #1 } { \q__bnvs }
      \exp_not:n { \q__bnvs }
      \BNVS_seq_use:in { #2 } { \q__bnvs }
    }
  }
}

\BNVS_new:bpn { seq_item:in } #1 {
  \BNVS_seq_use_N:Ni \seq_item:Nn { #1 }
}
\BNVS_new:bpn { use:Ni } #1 #2 {
  \exp_args:Nnc
  \use:n {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A ([^:_]*)_[^:]*:([NVn])
    } { \cs_to_str:N #1 }
  } { \BNVS_l_c:ti { seq } { match }
  } {
    \exp_args:Nx
    \tl_if_eq:nnT {
      \seq_item:in { match } { 3 }
    } { n } {
      \exp_args:NNV
    }
    \exp_args:Nc #1 { \BNVS_l_c:ti {
      \BNVS_seq_item:in { match } { 2 }
    } { #2 } }
  } {
    \BNVS_error:x { Unsupported~function:~\tl_to_str:N #1 }
  }
}
\BNVS_new:bpn { use_n:Nti } #1 #2 #3 {
  \exp_args:Nv #1 { \BNVS_l_c:ti { #2 } { #3 } }
}
\BNVS_new:bpn { generate_c_b_variants:N } #1 {
  \group_begin:
  \BNVS_seq_use_N:ni {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A([^:]+):N(.*)\Z
    } {
      \cs_to_str:N #1
    }
  } { match } {
    \cs_set:Npn \BNVS_:nn ##1 ##2 {
      \cs_new:cpn { ##1:c##2 } {
        \exp_args:Nc #1
      }
      \cs_new:cpn { ##1:b##2 } ####1 {
        \exp_args:Nc #1 { \BNVS_c:b { ####1 } }
      }
    }
    \exp_args:Nxx \BNVS_:nn {
      \BNVS_seq_item:in { match } {2}
    } {
      \BNVS_seq_item:in { match } {3}
    }
  } {
    \BNVS_error:x: { Unsupported~argument: #1 }
  }
  \group_end:
}
\BNVS_generate_c_b_variants:N \BNVS_use_n:Nti

\cs_new:Npn \BNVS_use_N:Nti #1 #2 #3 {
  \exp_args:Nc #1 { \BNVS_l_c:ti { #2 } { #3 } }
}
\BNVS_generate_c_b_variants:N \BNVS_use_N:Nti
\cs_new:Npn \BNVS_use_V:Nti #1 #2 #3 {
  \exp_args:Nv #1 { \BNVS_l_c:ti { #2 } { #3 } }
}
\BNVS_generate_c_b_variants:N \BNVS_use_V:Nti
\cs_new:Npn \BNVS_use:Nti #1 {
  \BNVS_seq_use_N:ni {
    \exp_args:Nnx
    \regex_extract_once:nnNTF { :([nNV]) } { \cs_to_str:N #1 }
  } { match } {
    \BNVS_use:b { use_ \BNVS_seq_item:in { match } {2} :Nti }
  } {
    \BNVS_error:x: { Unsupported~argument: #1 }
  }
}
\BNVS_generate_c_b_variants:N \BNVS_use:Nti
\cs_set_eq:NN \BNVS_begin: \group_begin:
\cs_set_eq:NN \BNVS_end: \group_end:
\exp_args_generate:n { xxx, xxxx }
\BNVS_new:bpn { new_i_wrap:Nt } #1 #2 {
  \BNVS_begin:
  \BNVS_seq_use_N:ni {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?([^:]+):([nN])(\S*)\Z
    } { \cs_to_str:N #1 }
  } { match } {
    \cs_set:Npn \BNVS_:nnn ##1 ##2 ##3 {
      \BNVS_new:bpn { ##1 :i ##3 } ####1 {
        \BNVS_use:b { ##1 :Nti } #1 { #2 } { ####1 }
      }
    }
    \exp_args:Nxxx \BNVS_:nnn {
      \BNVS_seq_item:in { match } {2}
    } {
      \BNVS_seq_item:in { match } {3}
    } {
      \BNVS_seq_item:in { match } {4}
    }
  } {
    \BNVS_error:x { Unsupported~function~\token_to_str:N #1 }
  }
  \BNVS_end:
}
\BNVS_generate_c_b_variants:N \BNVS_new_i_wrap:Nt
\BNVS_new:bpn { new_i_wrap:N } #1 {
  \BNVS_begin:
  \BNVS_seq_use_N:ni {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?(([^_:]+)_[^:]+):([nN])(\S*)\Z
    } { \cs_to_str:N #1 }
  } { match } {
  \BNVS_log:x { *****~new_i_wrap:N~->~\token_to_str:N #1}
    \cs_set:Npn \BNVS_:nnnn ##1 ##2 ##3 ##4 {
      \BNVS_new:bpn { ##1 :i ##4 } ####1 {
        \BNVS_use:b { ##3 :Nti } #1 { ##2 } { ####1 }
      }
    }
  \BNVS_log:x { *****~new_i_wrap:N~->~\token_to_str:N #1}
  \BNVS_log:x { *****~\seq_use:Nn \l__bnvs_match_seq {///} }
  \BNVS_log:x { *****~ \BNVS_use:nc {
      \BNVS_use_head_signed:nN {N} \seq_item:Nn
    } { \BNVS_l_c:ti { seq } { match } }
    {2}
  }
  \BNVS_log:x { *****~\BNVS_seq_use_N:Ni \seq_item:Nn { match } {2} }
  \BNVS_log:x { *****~\BNVS_seq_item:in { match } {3} }
  \BNVS_log:x { *****~\BNVS_seq_item:in { match } {4} }
  \BNVS_log:x { *****~\BNVS_seq_item:in { match } {5} }
  \BNVS_log:x { ***** }
    \exp_args:Nxxxx \BNVS_:nnnn {
      \BNVS_seq_item:in { match } {2}
    } {
      \BNVS_seq_item:in { match } {3}
    } {
      \BNVS_seq_item:in { match } {4}
    } {
      \BNVS_seq_item:in { match } {5}
    }
  } {
    \BNVS_error:x { Unsupported~function~\token_to_str:N #1 }
  }
  \BNVS_end:
}
\BNVS_generate_c_b_variants:N \BNVS_new_i_wrap:N
\exp_args_generate:n { xxxx }
\BNVS_new:bpn { new_ni_wrap:Nt } #1 #2 {
  \BNVS_begin:
  \BNVS_seq_use_N:ni {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?([^:]+):n([nN])(\S*)\Z
    } { \cs_to_str:N #1 }
  } { match } {
    \cs_set:Npn \BNVS_:nnn ##1 ##2 ##3 {
      \BNVS_new:bpn { ##1 :ni ##3 } #####1 ####2 {
        \BNVS_use:b { use_##2:nti } {
          #1 { ####1 }
        } { ##2 } { ####2 }
      }
    }
    \exp_args:Nxxx \BNVS_:nnn {
      \BNVS_seq_item:in { match } {2}
    } {
      \BNVS_seq_item:in { match } {3}
    } {
      \BNVS_seq_item:in { match } {4}
    }
  } {
    \BNVS_error:x { Unsupported~function~\token_to_str:N #1 }
  }
  \BNVS_end:
}
\BNVS_generate_c_b_variants:N \BNVS_new_ni_wrap:Nt
\BNVS_new:bpn { new_ii_wrap:Ntt } #1 #2 #3 {
  \BNVS_begin:
  \BNVS_seq_use_N:ni {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?([^:]+):([nN])([nN])(\S*)\Z
    } { \cs_to_str:N #1 }
  } { match } {
    \cs_set:Npn \BNVS_:nnnn ##1 ##2 ##3 ##4 {
      \BNVS_new:bpn { ##1 :ii ##4 } #####1 ####2 {
        \BNVS_use:b { use_##3:nti } {
          \BNVS_use:b { use_##2 :Nti } #1 { #2 } { ####1 }
        } { #3 } { ####2 }
      }
    }
    \exp_args:Nxxxx \BNVS_:nnnn {
      \BNVS_seq_item:in { match } {2}
    } {
      \BNVS_seq_item:in { match } {3}
    } {
      \BNVS_seq_item:in { match } {4}
    } {
      \BNVS_seq_item:in { match } {5}
    }
  } {
    \BNVS_error:x { Unsupported~function~\token_to_str:N #1 }
  }
  \BNVS_end:
}
\BNVS_generate_c_b_variants:N \BNVS_new_ii_wrap:Ntt
\exp_args_generate:n { xxxxx }
\BNVS_new:bpn { new_ii_wrap:Nt } #1 #2 {
  \BNVS_begin:
  \BNVS_seq_use_N:ni {
    \BNVS_log:x { ***** A:\cs_to_str:N \tl_set_eq:NN }
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?(([^_:]+)_[^:]+):([nN])([nN])(\S*)\Z
    } { \cs_to_str:N #1 }
  } { match } {
    \BNVS_log:x { ***** A}
    \BNVS_log:x { ***** \BNVS_seq_use:in { match } { // } }
    \cs_set:Npn \BNVS_:nnnnn ##1 ##2 ##3 ##4 ##5 {
      \BNVS_log:x { ***** C}
      \BNVS_new:bpn { ##1 :ii ##5 } ####1 ####2 {
        \BNVS_use:b { use_##4:nti } {
          \BNVS_use:b { use_##3:Nti } #1 { ##2 } { ####1 }
        } { #2 } { ####2 }
      }
      \BNVS_log:x { ***** D}
    }
    \BNVS_log:x { ***** B}
    \exp_args:Nxxxxx \BNVS_:nnnnn {
      \BNVS_seq_item:in { match } {2}
    } {
      \BNVS_seq_item:in { match } {3}
    } {
      \BNVS_seq_item:in { match } {4}
    } {
      \BNVS_seq_item:in { match } {5}
    } {
      \BNVS_seq_item:in { match } {6}
    }
    \BNVS_log:x { ***** E}
  } {
    \BNVS_error:x { Unsupported~function~\token_to_str:N \#1 }
  }
  \BNVS_end:
  \BNVS_log:x { ***** F}
}
\BNVS_generate_c_b_variants:N \BNVS_new_ii_wrap:Nt
\exp_args_generate:n { xxxxx }
\cs_new:Npn \BNVS_new_iii_wrap:Nttt #1 #2 #3 #4 {
  \BNVS_begin:
  \BNVS_seq_use_N:ni {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?([^:]+):([nN])([nN])([nN])(\S*) \Z
    } { \cs_to_str:N #1 }
  } { match } {
    \cs_set:Npn \BNVS_:nnnnn ##1 ##2 ##3 ##4 ##5 {
      \BNVS_new:bpn { ##1 :iii ##5 } ####1 ####2 ####3 {
        \BNVS_use:b { use_##4:nti } {
          \BNVS_use:b { use_##3:nti } {
            \BNVS_use:b { use_##2:Nti } #1 { #2 } { ####1 }
          } { #3 } { ####2 }
        } { #4 } { ####3 }
      }
    }
    \exp_args:Nxxxxx \BNVS_:nnnnn {
      \BNVS_seq_item:in { match } {2}
    } {
      \BNVS_seq_item:in { match } {3}
    } {
      \BNVS_seq_item:in { match } {4}
    } {
      \BNVS_seq_item:in { match } {5}
    } {
      \BNVS_seq_item:in { match } {6}
    }
  } {
    \BNVS_error:x { Unsupported~function~\token_to_str:N #1 }
  }
  \BNVS_end:
}
\BNVS_generate_c_b_variants:N \BNVS_new_iii_wrap:Nttt
\exp_args_generate:n { xxxxxx }
\cs_new:Npn \BNVS_new_iii_wrap:Ntt #1 #2 #3 {
  \BNVS_begin:
  \BNVS_seq_use_N:ni {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A (([^_]+)_[^:]+):([nN])([nN])([nN])(\S*) \Z
    } { \cs_to_str:N #1 }
  } { match } {
    \cs_set:Npn \BNVS_:nnnnnn ##1 ##2 ##3 ##4 ##5 ##6 {
      \BNVS_new:bpn { ##1 :iii ##6 } ####1 ####2 ####3 {
        \BNVS_use:b { use_##5:nti } {
          \BNVS_use:b { use_##4:nti } {
            \BNVS_use:b { use_##3:Nti } #1 { ##2 } { ####1 }
          } { #2 } { ####2 }
        } { #3 } { ####3 }
      }
    }
    \exp_args:Nxxxxxx \BNVS_:nnnnnn {
      \BNVS_seq_item:in { match } {2}
    } {
      \BNVS_seq_item:in { match } {3}
    } {
      \BNVS_seq_item:in { match } {4}
    } {
      \BNVS_seq_item:in { match } {5}
    } {
      \BNVS_seq_item:in { match } {6}
    } {
      \BNVS_seq_item:in { match } {7}
    }
  } {
    \BNVS_error:x { Unsupported~function~\token_to_str:N #1 }
  }
  \BNVS_end:
}
\BNVS_generate_c_b_variants:N \BNVS_new_iii_wrap:Ntt

\cs_new:Npn \BNVS_tl_use:Niii #1 #2 #3 {
  \BNVS_tl_use:ni {
    \BNVS_tl_use:ni {
      \BNVS_tl_use:Ni #1 { #2 }
    } { #3 }
  }
}
\cs_generate_variant:Nn \prg_new_conditional:Npnn { c }
\cs_new:Npn \BNVS_new_conditional:bpnn #1 {
  \prg_new_conditional:cpnn { \BNVS_c:b { #1 } }
}
\cs_generate_variant:Nn \prg_generate_conditional_variant:Nnn { c }
\BNVS_new:bpn { new_conditional_i_wrap:Nn } #1 #2 {
  \BNVS_begin:
  \BNVS_seq_use_N:ni {
\BNVS_log:n { *****~B:##1 }
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?([^:]*):([^TF]+)\Z
    } { \cs_to_str:N #1 }
  } { match } {
    \clist_map_inline:nn { #2 } {
      \tl_if_eq:nnTF { ##1 } { p } {
        \BNVS_new_i_wrap:c {
          \BNVS_seq_item:in { match } { 2 }
          _p:
          \BNVS_seq_item:in { match } { 3 }
        }
      } {
        \BNVS_new_i_wrap:b { \cs_to_str:N #1 ##1 }
      }
    }
  } {
    \BNVS_error:x { Unexpected~function:~\cs_to_str:N #1 }
  }
  \BNVS_end:
}


\BNVS_new:bpn { new_conditional_i_wrap:cn } #1 {
  \BNVS_new_conditional_i_wrap:cn { #1 }
}
\BNVS_new:bpn { new_conditional_i_wrap:bn } #1 {
  \BNVS_new_conditional_i_wrap:cn { \BNVS_c:b { #1 } }
}
\BNVS_new:bpn { new_conditional_ni_wrap:Nnt } #1 #2 #3 {
  \BNVS_begin:
  \BNVS_seq_use_N:ni {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?([^:]*):([^TF]*)\Z
    } { \cs_to_str:N #1 }
  } { match } {
    \clist_map_inline:nn { #2 } {
      \tl_if_eq:nnTF { ##1 } { p } {
        \BNVS_new_ni_wrap:ct {
          \BNVS_seq_item:in { match } { 2 }
          _p:
          \BNVS_seq_item:in { match } { 3 }
        } { #3 }
      } {
        \BNVS_new_ni_wrap:bt { \cs_to_str:N #1 ##1 } { #3 }
      }
    }
  } {
    \BNVS_error:x { Unexpected~function:~\cs_to_str:N #1 }
  }
  \BNVS_end:
}
\BNVS_new:bpn { new_conditional_ii_wrap:Nnt } #1 #2 #3 {
  \BNVS_begin:
  \BNVS_seq_use_N:ni {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?([^:]*):([^TF]*)\Z
    } { \cs_to_str:N #1 }
  } { match } {
    \clist_map_inline:nn { #2 } {
\BNVS_log:n { *****~new_conditional_ii_wrap:Nnt:~##1 }
      \tl_if_eq:nnTF { ##1 } { p } {
\BNVS_log:n { *****p }
        \BNVS_new_ii_wrap:ct {
          \BNVS_seq_item:in { match } { 2 }
          _p:
          \BNVS_seq_item:in { match } { 3 }
        } { #3 }
\BNVS_log:n { *****G }
      } {
        \BNVS_new_ii_wrap:bt { \cs_to_str:N #1 ##1 } { #3 }
      }
\BNVS_log:n { *****~DONE~##1 }
    }
  } {
    \BNVS_error:x { Unexpected~function:~\cs_to_str:N #1 }
  }
  \BNVS_end:
}
\cs_new:Npn \BNVS_new_conditional_ii_wrap:Nntt #1 #2 #3 #4 {
  \BNVS_begin:
  \BNVS_seq_use_N:nti {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?([^:]*):([^TF]*)\Z
    } { \cs_to_str:N #1 }
  } { match } {
    \clist_map_inline:nn { #2 } {
      \tl_if_eq:nnTF { ##1 } { p } {
        \BNVS_new_ii_wrap:ctt {
          \BNVS_seq_item:in { match } { 2 }
          _p:
          \BNVS_seq_item:in { match } { 3 }
        } { #3 } { #4 }
      } {
        \BNVS_new_ii_wrap:btt { \cs_to_str:N #1 ##1 } { #3 } { #4 }
      }
    }
  } {
    \BNVS_error:x { Unexpected~function:~\cs_to_str:N #1 }
  }
  \BNVS_end:
}
\cs_new:Npn \BNVS_new_conditional_ii_wrap:cnt #1 {
  \exp_args:Nc \BNVS_new_conditional_ii_wrap:Nnt { #1 }
}
\cs_new:Npn \BNVS_new_conditional_ii_wrap:bnt #1 {
  \BNVS_new_conditional_ii_wrap:cnt { \BNVS_c:b { #1 } }
}

\cs_new:Npn \BNVS_new_conditional_iii_wrap:Nnttt #1 #2 #3 #4 #5 {
  \BNVS_begin:
  \BNVS_seq_use_N:nti {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?([^:]*):([^TF]*)\Z
    } { \cs_to_str:N #1 }
  } { match } {
    \clist_map_inline:nn { #2 } {
      \tl_if_eq:nnTF { ##1 } { p } {
        \BNVS_new_iii_wrap:cttt {
          \BNVS_seq_item:in { match } { 2 }
          _p:
          \BNVS_seq_item:in { match } { 3 }
        } { #3 } { #4 } { #5 }
      } {
        \BNVS_new_iii_wrap:bttt {
          \cs_to_str:N #1 ##1
        } { #3 } { #4 } { #5 }
      }
    }
  } {
    \BNVS_error:x { Unexpected~function:~\cs_to_str:N #1 }
  }
  \BNVS_end:
}
\cs_new:Npn \BNVS_new_conditional_iii_wrap:Nntt #1 #2 #3 #4 {
  \BNVS_begin:
  \BNVS_seq_use_N:nti {
    \exp_args:Nnx
    \regex_extract_once:nnNTF {
      \A(?:BNVS_)?([^:]*):([^TF]*)\Z
    } { \cs_to_str:N #1 }
  } { match } {
    \clist_map_inline:nn { #2 } {
      \tl_if_eq:nnTF { ##1 } { p } {
        \BNVS_new_iii_wrap:ctt {
          \BNVS_seq_item:in { match } { 2 }
          _p:
          \BNVS_seq_item:in { match } { 3 }
        } { #3 } { #4 }
      } {
        \BNVS_new_iii_wrap:btt {
          \cs_to_str:N #1 ##1
        } { #3 } { #4 }
      }
    }
  } {
    \BNVS_error:x { Unexpected~function:~\cs_to_str:N #1 }
  }
  \BNVS_end:
}
\BNVS_new:bpn { regex_use:Ni } #1 #2 {
  \BNVS_use:Nc #1 { c__ \BNVS_c:b { #2 } _regex }
}
\BNVS_new_conditional:bpnn { extract_once:in } #1 #2 { T, F, TF } {
  \BNVS_seq_use_N:ni {
    \BNVS_use:Nc \regex_extract_once:NnNTF { \BNVS_c_c:ti { regex } { #1 } } { #2 }
  } { match } { \prg_return_true: } { \prg_return_false: }
}
\BNVS_new_conditional:bpnn { extract_once:Nn } #1 #2 { T, F, TF } {
  \BNVS_seq_use_N:ni {
    \regex_extract_once:NnNTF #1 { #2 }
  } { match } { \prg_return_true: } { \prg_return_false: }
}
\BNVS_new_conditional:bpnn { extract_once:Ni } #1 #2 { T, F, TF } {
  \BNVS_seq_use_N:ni {
    \BNVS_tl_use_n:ni {
      \regex_extract_once:NnNTF #1
    } { #2 }
  } { match } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { extract_once:nn } #1 #2 { T, F, TF } {
  \BNVS_seq_use_N:ni {
    \regex_extract_once:nnNTF { #1 } { #2 }
  } { match } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { match_pop_left:i } #1 { T, F, TF } {
  \BNVS_tl_use_N:ni {
    \BNVS_seq_use_N:Ni \seq_pop_left:NNTF { match }
  } { #1 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { regex_split:ini } #1 #2 #3 { T, F, TF } {
  \BNVS_seq_use_N:ni {
    \BNVS_regex_use:Ni \regex_split:NnNTF { #1 } { #2 }
  } { #3 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { regex_split:in } #1 #2 { T, F, TF } {
  \BNVS_seq_use_N:ni {
    \BNVS_use:Nti \regex_split:NnNTF { regex } { #1 } { #2 }
  } { split } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_i_wrap:N \tl_clear:N
\BNVS_new_i_wrap:N \tl_count:N
\BNVS_new_ii_wrap:Nt \tl_set_eq:NN { tl }
\BNVS_new_i_wrap:N \tl_set:Nn
\BNVS_new_i_wrap:N \tl_set:Nx
\BNVS_new_ii_wrap:Nt \tl_set:Nn { tl }
\BNVS_new_i_wrap:N \tl_put_right:Nn
\BNVS_new_i_wrap:N \tl_put_right:Nx
\BNVS_new_ii_wrap:Nt \tl_put_right:Nn { tl }
\BNVS_new_i_wrap:N \tl_put_left:Nn
\BNVS_new_i_wrap:N \tl_put_left:Nx
\BNVS_new_ii_wrap:Nt \tl_put_left:Nn { tl }
\BNVS_new_conditional_i_wrap:Nn \tl_if_empty:N { p, T, F, TF }
\BNVS_new_conditional_i_wrap:Nn \tl_if_blank:N { p, T, F, TF }
\BNVS_new_conditional_i_wrap:Nn \tl_if_eq:nn { T, F, TF }
\BNVS_new_conditional_ii_wrap:Nnt \tl_if_eq:NN { p, T, F, TF } { tl }
\BNVS_new_conditional_i_wrap:Nn \str_if_eq:nn { T, F, TF }
\BNVS_new_conditional_ii_wrap:Nnt \str_if_eq:NN { T, F, TF } { str }
\BNVS_new_i_wrap:N \seq_count:N
\BNVS_new_i_wrap:N \seq_clear:N
\BNVS_new_i_wrap:N \seq_use:Nn
\BNVS_new_i_wrap:N \seq_remove_all:Nn
\BNVS_new_i_wrap:N \seq_map_inline:Nn
\BNVS_new_ii_wrap:Nt \seq_set_eq:NN    { seq }
\BNVS_new_ii_wrap:Nt \seq_put_left:Nn  { tl }
\BNVS_new_ii_wrap:Nt \seq_put_right:Nn { tl }
\BNVS_new_ii_wrap:Nt \seq_pop_left:NN  { tl }
\BNVS_new_ii_wrap:Nt \seq_pop_right:NN { tl }

\BNVS_new_i_wrap:N \seq_set_split:Nnn

\BNVS_new_i_wrap:N \seq_set_split:Nnv
\BNVS_new_i_wrap:N \seq_set_split:Nnx
\BNVS_log:n { ********** }
\BNVS_new_conditional_i_wrap:Nn \seq_if_empty:N { T, F, TF }
\BNVS_new_conditional_ii_wrap:Nnt \seq_get_right:NN { T, F, TF } { tl }
\BNVS_new_conditional_ii_wrap:Nnt \seq_pop_left:NN { T, F, TF } { tl }
\BNVS_new_conditional_ii_wrap:Nnt \seq_pop_right:NN { T, F, TF } { tl }
\BNVS_new_i_wrap:N \int_zero:N
\BNVS_new_i_wrap:N \int_incr:N
\BNVS_new_i_wrap:N \int_decr:N
\BNVS_new_i_wrap:N \int_set:Nn
\BNVS_new_ii_wrap:Nt \int_set:NN { int }
\BNVS_new_conditional:bpnn { prop_get:Nni } #1 #2 #3 { T, F, TF } {
  \BNVS_use_N:nti {
    \prop_get:NnNTF #1 { #2 }
  } { tl } { #3 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\cs_new:Npn \BeanovesDebugOn {
  \BNVS_warning:x { Debugging~mode~requires~\jobname-debug.sty,~typeset~\jobname.dtx}
}
\cs_new:Npn \BeanovesDebugOff { \BeanovesDebugOn }
\tl_new:N \l__bnvs_id_last_tl
\tl_set:Nn \l__bnvs_id_last_tl { ?! }
\tl_new:N \l__bnvs_a_tl
\tl_new:N \l__bnvs_b_tl
\tl_new:N \l__bnvs_c_tl
\tl_new:N \l__bnvs_V_tl
\tl_new:N \l__bnvs_A_tl
\tl_new:N \l__bnvs_L_tl
\tl_new:N \l__bnvs_Z_tl
\tl_new:N \l__bnvs_ans_tl
\tl_new:N \l__bnvs_key_tl
\tl_new:N \l__bnvs_key_base_tl
\tl_new:N \l__bnvs_id_tl
\tl_new:N \l__bnvs_n_tl
\tl_new:N \l__bnvs_path_tl
\tl_new:N \l__bnvs_group_tl
\tl_new:N \l__bnvs_scan_tl
\tl_new:N \l__bnvs_query_tl
\tl_new:N \l__bnvs_token_tl
\tl_new:N \l__bnvs_root_tl
\tl_new:N \l__bnvs_n_incr_tl
\tl_new:N \l__bnvs_incr_tl
\tl_new:N \l__bnvs_post_tl
\tl_new:N \l__bnvs_suffix_tl
\int_new:N \g__bnvs_call_int
\int_new:N \l__bnvs_int
\seq_new:N \g__bnvs_def_seq
\seq_new:N \l__bnvs_a_seq
\seq_new:N \l__bnvs_b_seq
\seq_new:N \l__bnvs_ans_seq
\seq_new:N \l__bnvs_match_seq
\seq_new:N \l__bnvs_split_seq
\seq_new:N \l__bnvs_path_seq
\seq_new:N \l__bnvs_path_base_seq
\seq_new:N \l__bnvs_query_seq
\seq_new:N \l__bnvs_token_seq
\bool_new:N \l__bnvs_in_frame_bool
\bool_set_false:N \l__bnvs_in_frame_bool
\bool_new:N \l__bnvs_parse_bool
\bool_new:N \l__bnvs_provide_bool
\BNVS_new:bpn { provide_on: } {
  \bool_set_true:N \l__bnvs_provide_bool
}
\BNVS_new:bpn { provide_off: } {
  \bool_set_false:N \l__bnvs_provide_bool
}
\BNVS_provide_off:
\BNVS_new_conditional:bpnn { if_provide: } { p, T, F, TF } {
  \bool_if:NTF \l__bnvs_provide_bool {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\int_const:Nn \c__bnvs_max_call_int { 2048 }
\cs_set:Npn  \BNVS_call_greset: {
  \int_gset:Nn \g__bnvs_call_int { \c__bnvs_max_call_int }
}
\BNVS_new_conditional:bpnn { call: } { T, F, TF } {
  \int_gdecr:N \g__bnvs_call_int
  \int_compare:nNnTF \g__bnvs_call_int > 0 {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { quark_if_nil:i } #1 { T, F, TF } {
  \BNVS_tl_use:Ni \quark_if_nil:NTF { #1 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { quark_if_no_value:i } #1 { T, F, TF } {
  \BNVS_tl_use:Ni \quark_if_no_value:NTF { #1 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\prop_new:N \g__bnvs_prop
\NewDocumentCommand\BeanovesLogGProp {O{20}} { \BNVS_error:n {Only~with~beanoves-debug} }
\BNVS_new:bpn { gput:nnn } #1 #2 {
  \prop_gput:Nnn \g__bnvs_prop { #2 / #1 }
}
\BNVS_new:bpn { gput:nni } #1 #2 {
  \BNVS_tl_use:ni {
    \BNVS_gput:nnn { #1 } { #2 }
  }
}
\BNVS_new:bpn { item:nn } #1 #2 {
  \prop_item:Nn \g__bnvs_prop { #2 / #1 }
}
\BNVS_new:bpn { gremove:nn } #1 #2 {
  \prop_gremove:Nn \g__bnvs_prop { #2 / #1 }
}
\BNVS_new:bpn { gclear:n } #1 {
  \clist_map_inline:nn { V, A, Z, L } {
    \BNVS_gremove:nn { ##1 } { #1 }
    \BNVS_gremove:nn { ##1/0 } { #1 }
  }
  \BNVS_kip_gremove:n { #1 }
  \BNVS_cache_gclear:n { #1 }
}
\BNVS_new:bpn { gclear:v } {
   \BNVS_tl_use:Ni \BNVS_gclear:n
}
\BNVS_new:bpn { gclear: } {
  \prop_gclear:N \g__bnvs_prop
}
\BNVS_new:bpn { gput_nil:ii } #1 #2 {
  \BNVS_gput:nnn { #1 } { #2 } { \q_nil }
}
\BNVS_new:bpn { gput_no_value:nn } #1 #2 {
  \BNVS_gput:nnn { #1 } { #2 } { \q_no_value }
}
\BNVS_new:bpn { gput_no_value:nnv } #1 #2 #3 {
  \BNVS_gput_no_value:nn { #1 } { #2 }
  \BNVS_gput:nni { #1/0 } { #2 } { #3 }
}
\BNVS_new_conditional:bpnn { if_in:nn } #1 #2 { p, T, F, TF } {
  \prop_if_in:NnTF \g__bnvs_prop { #2 / #1 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { if_in:n } #1 { p, T, F, TF } {
  \bool_if:nTF {
       \BNVS_if_in_p:nn V { #1 }
    || \BNVS_if_in_p:nn A { #1 }
    || \BNVS_if_in_p:nn Z { #1 }
  } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { if_in:v } #1 { p, T, F, TF } {
  \BNVS_tl_use:Ni \BNVS_if_in:nTF { #1 }
    { \prg_return_true: } { \prg_return_false: }
}

\BNVS_new:bpn { gprovide:nnnT } #1 #2 #3 #4 {
  \prop_if_in:NnF \g__bnvs_prop { #2 / #1 } {
    #4
    \prop_gput:Nnn \g__bnvs_prop { #2 / #1 } { #3 }
  }
}
\BNVS_new_conditional:bpnn { get:nnc } #1 #2 #3 { T, F, TF } {
  \BNVS_tl_use_N:ni {
    \prop_get:NnNTF \g__bnvs_prop { #2 / #1 }
  } { #3 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional_ni_wrap:Nnt \BNVS_get:nni { T, F, TF }
\prop_new:N \g__bnvs_kip_prop
\BNVS_new:bpn { kip_gput:nnnn } #1 #2 #3 #4 {
  \prop_gput:Nnn \g__bnvs_kip_prop { #1 } {
    \BNVS_k:n { #2 }
    \BNVS_i:n { #3 }
    \BNVS_p:n { #4 }
  }
}
\BNVS_new:bpn { kip_gput:nvvv } #1 #2 #3 #4 {
  \exp_args:Nnx \use:n {
    \BNVS_tl_use:ni {
      \BNVS_tl_use:ni {
        \BNVS_kip_gput:nnnn { #1 }
      } { #2 }
    } { #3 }
  } { \BNVS_seq_use:in { #4 } . }
}
\BNVS_new:bpn { kip_gput:vvvv } #1 #2 #3 #4 {
  \exp_args:Nnx \use:n {
    \BNVS_tl_use:ni {
      \BNVS_tl_use:ni {
        \BNVS_tl_use:Ni \BNVS_kip_gput:nnnn { #1 }
      } { #2 }
    } { #3 }
  } { \BNVS_seq_use:in { #4 } . }
}
\BNVS_new:bpn { kip_gput_nil:n } #1 {
  \prop_gput:Nnn \g__bnvs_kip_prop { #1 } { \q_nil }
}
\BNVS_new:bpn { kip_gremove:n } {
  \prop_gremove:Nn \g__bnvs_kip_prop
}
\BNVS_new:bpn { kip_gclear: } {
  \prop_gclear:N \g__bnvs_kip_prop
}
\prg_new_conditional:Npnn \BNVS_kip_if_in:n #1 { p, T, F, TF } {
  \prop_if_in:NnTF \g__bnvs_kip_prop { #1 }
    { \prg_return_true: } { \prg_return_false: }
}
\tl_new:N \l__bnvs_kip_tl
\BNVS_new_conditional:bpnn { kip_get:nccc } #1 #2 #3 #4 { T, F, TF } {
  \BNVS_tl_use:ni {
    \prop_get:NnNTF \g__bnvs_kip_prop { #1 }
  } { kip } {
    \BNVS_tl_use:Ni \quark_if_nil:NTF { kip } {
      \BNVS_fatal:n {Circular~definition:~#1}
      \BNVS_tl_set:in { #2 } { \q_nil }
      \prg_return_false:
    } {
      \BNVS_set:bpn { k:n } { \BNVS_tl_set:in { #2 } }
      \BNVS_set:bpn { i:n } { \BNVS_tl_set:in { #3 } }
      \BNVS_set:bpn { p:n } {
         \BNVS_seq_set_split:inn { #4 } .
      }
      \BNVS_tl_use:i { kip }
      \prg_return_true:
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { kip_get:vccc } #1 #2 #3 #4 { T, F, TF } {
  \BNVS_tl_use:Ni \BNVS_kip_get:ncccTF { #1 } { #2 } { #3 } { #4 }
    { \prg_return_true: } { \prg_return_false: }
}
\prop_new:N \g__bnvs_cache_prop
\BNVS_new:bpn { cache_gput:iin } #1 #2 {
  \prop_gput:Nnn \g__bnvs_cache_prop { #2 / #1 }
}
\cs_generate_variant:Nn \BNVS_cache_gput:iin { nV, nnV }
\BNVS_new:bpn { cache_gput:nvn } #1 {
  \BNVS_tl_use:ni {
    \BNVS_cache_gput:nVn { #1 }
  }
}
\BNVS_new:bpn { cache_gput:nni } #1 #2 {
  \BNVS_tl_use:ni {
    \BNVS_cache_gput:nnV { #1 } { #2 }
  }
}
\BNVS_new:bpn { cache_item:nn } #1 #2 {
  \prop_item:Nn \g__bnvs_cache_prop { #2 / #1 }
}
\BNVS_new:bpn { cache_gremove:nn } #1 #2 {
  \prop_gremove:Nn \g__bnvs_cache_prop { #2 / #1 }
}
\BNVS_new:bpn { cache_gclear:n } #1 {
  \clist_map_inline:nn { V, A, Z, L, P, N } {
    \prop_gremove:Nn \g__bnvs_cache_prop { #1 / ##1 }
  }
}
\BNVS_new:bpn { cache_gclear: } {
  \prop_gclear:N \g__bnvs_cache_prop
}
\prg_new_conditional:Npnn \BNVS_cache_if_in:nn #1 #2 { p, T, F, TF } {
  \prop_if_in:NnTF \g__bnvs_cache_prop { #2 / #1 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { cache_get:nni } #1 #2 #3 { p, T, F, TF } {
  \BNVS_tl_use:ni {
    \prop_get:NnNTF \g__bnvs_cache_prop { #2 / #1 }
  } { #3 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional_ni_wrap:Nnt \BNVS_cache_get:nni { T, F, TF }
\prop_new:N \g__bnvs_v_prop
\BNVS_new:bpn { v_gput:nn } {
  \prop_gput:Nnn \g__bnvs_v_prop
}
\BNVS_new:bpn { v_gput:nv } #1 {
  \BNVS_tl_use:ni {
    \BNVS_v_gput:nn { #1 }
  }
}
\BNVS_new:bpn { v_item:n } #1 {
  \prop_item:Nn \g__bnvs_v_prop { #1 }
}
\BNVS_new:bpn { v_gremove:n } {
  \prop_gremove:Nn \g__bnvs_v_prop
}
\BNVS_new:bpn { v_gclear: } {
  \prop_gclear:N \g__bnvs_v_prop
}
\BNVS_new_conditional:bpnn { v_if_in:n } #1 { p, T, F, TF } {
  \prop_if_in:NnTF \g__bnvs_v_prop { #1 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { v_get:ni } #1 #2 { T, F, TF } {
  \BNVS_tl_use:ni {
    \prop_get:NnNTF \g__bnvs_v_prop { #1 }
  } { #2 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { v_greset:nn } #1 #2 { T, F, TF } {
  \BNVS_v_if_in:nTF { #1 } {
    \BNVS_v_gremove:n { #1 }
    \tl_if_empty:nF { #2 } {
      \BNVS_v_gput:nn { #1 } { #2 }
    }
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { v_greset:vn } #1 #2 { T, F, TF } {
  \BNVS_tl_use:Ni \BNVS_v_greset:nnTF { #1 } { #2 }
    { \prg_return_true: } { \prg_return_false: }
}
\BNVS_new_conditional:bpnn { greset_all:nn } #1 #2 { T, F, TF } {
  \BNVS_if_in:nTF { #1 } {
    \BNVS_begin:
    \clist_map_inline:nn { V, A, Z, L } {
      \BNVS_get:nniT { ##1 } { #1 } { a } {
        \BNVS_quark_if_nil:iT { a } {
          \BNVS_cache_get:nniTF { ##1 } { #1 } { a } {
            \BNVS_gput:nni { ##1 } { #1 } { a }
          } {
            \BNVS_gput:nnn { ##1 } { #1 } { 1 }
          }
        }
      }
    }
    \BNVS_end:
    \BNVS_cache_gclear:n { #1 }
    \BNVS_v_greset:nnT { #1 } { #2 } {}
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { greset_all:vn } #1 #2 { T, F, TF } {
  \BNVS_tl_use:Ni \BNVS_greset_all:nnTF { #1 } { #2 }
    { \prg_return_true: } { \prg_return_false: }
}
\BNVS_new:bpn { gclear_all: } {
  \BNVS_gclear:
  \BNVS_cache_gclear:
  \BNVS_n_gclear:
  \BNVS_v_gclear:
  \BNVS_kip_gclear:
}
\BNVS_new:bpn { gclear_all:n } #1 {
  \BNVS_gclear:n { #1 }
  \BNVS_cache_gclear:n { #1 }
  \BNVS_n_gremove:n { #1 }
  \BNVS_v_gremove:n { #1 }
}
\prop_new:N \g__bnvs_n_prop
\BNVS_new:bpn { n_gput:nn } {
  \prop_gput:Nnn \g__bnvs_n_prop
}
\BNVS_new:bpn { n_gput:nv } #1 {
  \BNVS_tl_use:Ni \BNVS_n_gput:nn { #1 }
}
\BNVS_new:bpn { n_gprovide:nn } #1 #2 {
  \prop_if_in:NnF \g__bnvs_n_prop { #1 } {
    \prop_gput:Nnn \g__bnvs_n_prop { #1 } { #2 }
  }
}
\BNVS_new:bpn { n_item:n } #1 {
  \prop_item:Nn \g__bnvs_n_prop { #1 }
}
\BNVS_new:bpn { n_gremove:n } {
  \prop_gremove:Nn \g__bnvs_n_prop
}
\BNVS_new:bpn { n_gremove:v } {
  \BNVS_tl_use:Ni \BNVS_n_gremove:n
}
\BNVS_new:bpn { n_gclear: } {
  \prop_gclear:N \g__bnvs_n_prop
}
\prg_new_conditional:Npnn \BNVS_n_if_in:n #1 { p, T, F, TF } {
  \prop_if_in:NnTF \g__bnvs_n_prop { #1 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { n_get:ni } #1 #2 { T, F, TF } {
  \BNVS_prop_get:NniTF \g__bnvs_n_prop { #1 } { #2 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\regex_const:Nn \c__bnvs_name_regex {
  [[:alpha:]_][[:alnum:]_]*
}
\regex_const:Nn \c__bnvs_id_regex {
  (?: \ur{c__bnvs_name_regex} | [?] )? !
}
\regex_const:Nn \c__bnvs_path_regex {
  (?: \. \ur{c__bnvs_name_regex} | \. [-+]? \d+ )*
}
\regex_const:Nn \c__bnvs_A_key_Z_regex {
  \A ( ( \ur{c__bnvs_id_regex} ? ) \ur{c__bnvs_name_regex} )
  ( \ur{c__bnvs_path_regex} ) \Z
}
\regex_const:Nn \c__bnvs_TEST_A_key_n_Z_regex {
  \A ( ( \ur{c__bnvs_id_regex} ? )
  \ur{c__bnvs_name_regex}
  (?: \. \ur{c__bnvs_name_regex} | \. [-+]? \d+ )*? )
  ( \. n )? \Z
}
\regex_const:Nn \c__bnvs_colons_regex { :(:+)? }
\regex_const:Nn \c__bnvs_split_regex {
  \s* ( ? :
      \+\+
    ( ( \ur{c__bnvs_id_regex}? ) \ur{c__bnvs_name_regex} )
    ( \ur{c__bnvs_path_regex} )
    | ( ( \ur{c__bnvs_id_regex}? ) \ur{c__bnvs_name_regex} )
      ( \ur{c__bnvs_path_regex} )
      (?: \.(\+)\+n
      |  \s* \+= \s* ( \S+ )
      | (\+)\+
    )?
  ) \s*
}
\RequirePackage{keyval}
\define@key{beamerframe}{beanoves~id}[]{
  \tl_set:Nx \l__bnvs_id_last_tl { #1 ! }
}
\AddToHook{env/beamer@frameslide/before}{
  \BNVS_n_gclear:
  \BNVS_v_gclear:
  \bool_set_true:N \l__bnvs_in_frame_bool
}
\AddToHook{env/beamer@frameslide/after}{
  \bool_set_false:N \l__bnvs_in_frame_bool
}
\BNVS_new_conditional:bpnn { split_pop_left:v } #1 { T, F, TF } {
  \BNVS_seq_pop_left:iiTF { split } { #1 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { range_set:cccn } #1 #2 #3 #4 { T, F, TF } {
  \BNVS_begin:
  \BNVS_tl_clear:i { a }
  \BNVS_tl_clear:i { b }
  \BNVS_tl_clear:i { c }
  \BNVS_regex_split:inTF { colons } { #4 } {
    \BNVS_seq_pop_left:iiT { split } { a } {
      \BNVS_seq_pop_left:iiT { split } { b } {
        \BNVS_tl_if_empty:iTF { b } {
          \BNVS_split_pop_left:vTF { b } {
            \BNVS_seq_pop_left:iiT { split } { c } {
              \BNVS_tl_if_empty:iTF { c } {
                \BNVS_error:n { Invalid~range~expression(1):~#4 }
              } {
                \int_compare:nNnT { \BNVS_tl_count:v { c } } > { 1 } {
                  \BNVS_error:n { Invalid~range~expression(2):~#4 }
                }
                \BNVS_split_pop_left:vTF { c } {
                  \BNVS_seq_if_empty:iF { split } {
                    \BNVS_error:n { Invalid~range~expression(3):~#4 }
                  }
                } {
                  \BNVS_error:n { Internal~error }
                }
              }
            }
          } {
          }
        } {
          \int_compare:nNnT { \BNVS_tl_count:v { b } } > { 1 } {
            \BNVS_error:n { Invalid~range~expression(4):~#4 }
          }
          \BNVS_seq_pop_left:iiT { split } { c } {
            \BNVS_split_pop_left:vTF { b } {
              \BNVS_tl_if_empty:iTF { b } {
                \BNVS_seq_pop_left:ii { split } { b }
                \BNVS_seq_if_empty:iF { split } {
                  \BNVS_error:n { Invalid~range~expression(5):~#4 }
                }
              } {
                \BNVS_error:n { Invalid~range~expression(6):~#4 }
              }
            } {
              \BNVS_tl_clear:i { b }
            }
          }
        }
      }
    }
    \cs_set:Npn \BNVS_next: { }
    \BNVS_tl_if_empty:iT { a } {
      \BNVS_tl_if_empty:iT { b } {
        \BNVS_tl_if_empty:iT { c } {
          \cs_set:Npn \BNVS_next: {
            \BNVS_error:n { Invalid~range~expression(7):~#3 }
          }
        }
      }
    }
    \BNVS_next:
    \cs_set:Npn \BNVS_:nnn ##1 ##2 ##3 {
      \BNVS_end:
      \BNVS_tl_set:in { #1 } { ##1 }
      \BNVS_tl_set:in { #2 } { ##2 }
      \BNVS_tl_set:in { #3 } { ##3 }
    }
    \BNVS_tl_use:Niii \BNVS_:nnn { a } { b } { c }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new:bpn { range:nnnn } #1 {
  \BNVS_if_provide:TF {
    \BNVS_if_in:nnTF A { #1 } {
      \use_none:nnn
    } {
      \BNVS_if_in:nnTF Z { #1 } {
        \use_none:nnn
      } {
        \BNVS_if_in:nnTF L { #1 } {
          \use_none:nnn
        } {
          \BNVS_do_range:nnnn { #1 }
        }
      }
    }
  } {
    \BNVS_do_range:nnnn { #1 }
  }
}
\BNVS_new:bpn { range:nvvv } #1 #2 #3 #4 {
  \BNVS_tl_use:ni {
    \BNVS_tl_use:ni {
      \BNVS_tl_use:ni {
        \BNVS_use:b { range:nnnn } { #1 }
      } { #2 }
    } { #3 }
  } { #4 }
}
\BNVS_new:bpn { parse_record:n }  #1 {
  \BNVS_if_provide:TF {
    \BNVS_gprovide:nnnT V { #1 } { 1 } {
      \BNVS_gclear:n { #1 }
    }
  } {
    \BNVS_gclear:n { #1 }
    \BNVS_gput:nnn V { #1 } { 1 }
  }
}
\cs_generate_variant:Nn \BNVS_parse_record:n { V }
\BNVS_new:bpn { parse_record:v } {
  \BNVS_tl_use:ni {
    \BNVS_parse_record:V
  }
}
\BNVS_new:bpn { parse_record:nn } #1 #2 {
  \BNVS_range_set:cccnTF { a } { b } { c } { #2 } {
    \BNVS_range:nvvv { #1 } { a } { b } { c }
  } {
    \BNVS_if_provide:TF {
      \BNVS_gprovide:nnnT V { #1 } { #2 } {
        \BNVS_gclear_all:n { #1 }
      }
    } {
      \BNVS_gclear_all:n { #1 }
      \BNVS_gput:nnn V { #1 } { #2 }
    }
  }
}
\cs_generate_variant:Nn \BNVS_parse_record:nn { x, V }
\BNVS_new:bpn { parse_record:vn } {
  \BNVS_tl_use:ni {
    \BNVS_parse_record:Vn
  }
}
\BNVS_new:bpn { n_parse_record:n } #1 {
  \bool_if:NTF \l__bnvs_n_provide_bool {
    \BNVS_n_gprovide:nn
  } {
    \BNVS_n_gput:nn
  }
  { #1 } { 1 }
}
\cs_generate_variant:Nn \BNVS_n_parse_record:n { V }
\BNVS_new:bpn { n_parse_record:v } {
  \BNVS_tl_use:ni {
    \BNVS_n_parse_record:V
  }
}
\BNVS_new:bpn { n_parse_record:nn } #1 #2 {
  \BNVS_range_set:cccnTF { a } { b } { c } { #2 } {
    \BNVS_error:n { Unexpected~range:~#2 }
  } {
    \BNVS_if_provide:TF {
      \BNVS_n_gprovide:nn { #1 } { #2 }
    } {
      \BNVS_n_gput:nn { #1 } { #2 }
    }
  }
}
\cs_generate_variant:Nn \BNVS_n_parse_record:nn { x, V }
\BNVS_new:bpn { n_parse_record:vn } {
  \BNVS_tl_use:Ni \BNVS_n_parse_record:Vn
}
\BNVS_new:bpn { name_id_n_end_export: } {
  \cs_set:Npn \BNVS_:nnn ##1 ##2 ##3 {
    \BNVS_end:
    \BNVS_tl_set:in { key } { ##1 }
    \BNVS_tl_set:in { id } { ##2 }
    \BNVS_tl_set:in { n } { ##3 }
  }
  \BNVS_tl_if_empty:iTF { id } {
    \BNVS_tl_use:Niii \BNVS_:nnn { key } { id_last } { n }
    \BNVS_tl_put_left:cv { key } { id_last }
  } {
    \BNVS_tl_use:Niii \BNVS_:nnn { key } { id } { n }
    \BNVS_tl_set:vv { id_last } { id }
  }
}
\BNVS_new_conditional:bpnn { name_id_n_get:n } #1 { T, F, TF } {
  \BNVS_begin:
  \BNVS_extract_once:NnTF \c__bnvs_TEST_A_key_n_Z_regex { #1 } {
    \BNVS_match_pop_left:iTF { key } {
      \BNVS_match_pop_left:iTF { key } {
        \BNVS_match_pop_left:iTF { id } {
          \BNVS_match_pop_left:iTF { n } {
            \BNVS_name_id_n_end_export:
            \prg_return_true:
          } {
            \BNVS_end:
            \BNVS_error:n { LOGICALLY_UNREACHABLE_A_key_n_Z/n }
            \prg_return_false:
          }
        } {
          \BNVS_end:
          \BNVS_error:n { LOGICALLY_UNREACHABLE_A_key_n_Z/id }
          \prg_return_false:
        }
      } {
        \BNVS_end:
        \BNVS_error:n { LOGICALLY_UNREACHABLE_A_key_n_Z/name }
        \prg_return_false:
      }
    } {
      \BNVS_end:
      \BNVS_error:n { LOGICALLY_UNREACHABLE_A_key_n_Z/n }
      \prg_return_false:
    }
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { name_id_n_get:v } #1 { T, F, TF } {
  \BNVS_tl_use:ni { \BNVS_use:b { name_id_n_get:nTF } } { #1 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new:bpn { parse:n } #1 {
  \peek_remove_spaces:n {
    \peek_catcode:NTF \c_group_begin_token {
      \BNVS_tl_if_empty:iTF { root } {
        \BNVS_error:n { Unexpected~list~at~top~level. }
      }
      \BNVS_begin:
      \BNVS_int_incr:c { }
      \BNVS_tl_set:vx { root } { \BNVS_int_use:c { } . }
      \cs_set:Npn \bnvs:nw ####1 ####2 \s_stop {
        \regex_match:nnT { \S* } { ####2 } {
          \BNVS_error:n { Unexpected~####2 }
        }
        \keyval_parse:nnn {
          \BNVS_parse:n
        } {
          \BNVS_parse:nn
        } { ####1 }
        \BNVS_end:
      }
      \bnvs:nw
    } {
      \BNVS_tl_if_empty:iTF { root } {
        \BNVS_name_id_n_get:nTF { #1 } {
          \BNVS_tl_if_empty:iTF { n } {
            \BNVS_parse_record:v
          } {
            \BNVS_n_parse_record:v
          }
          { key }
        } {
          \BNVS_error:n { Unexpected~key:~#1 }
        }
      } {
        \BNVS_int_incr:c { }
        \BNVS_tl_if_empty:iTF { n } {
          \BNVS_parse_record:xn
        } {
          \BNVS_n_parse_record:xn
        } {
          \BNVS_tl_use:v { root } . \BNVS_int_use:c { }
        } { #1 }
      }
      \use_none_delimit_by_s_stop:w
    }
  }
  #1 \s_stop
}
\BNVS_new:bpn { do_range:nnnn } #1 #2 #3 #4 {
    \BNVS_gclear_all:n { #1 }
  \tl_if_empty:nTF { #4 } {
    \tl_if_empty:nTF { #2 } {
      \tl_if_empty:nTF { #3 } {
        \BNVS_error:n { Not~a~range:~:~#1 }
      } {
        \BNVS_gput:nnn Z { #1 } { #3 }
        \BNVS_gput_nil:ii V { #1 }
      }
    } {
      \BNVS_gput:nnn A { #1 } { #2 }
      \BNVS_gput_nil:ii V { #1 }
      \tl_if_empty:nF { #3 } {
        \BNVS_gput:nnn Z { #1 } { #3 }
        \BNVS_gput_nil:ii L { #1 }
      }
    }
  } {
    \tl_if_empty:nTF { #2 } {
      \BNVS_gput:nnn L { #1 } { #4 }
      \tl_if_empty:nF { #3 } {
        \BNVS_gput:nnn Z { #1 } { #3 }
        \BNVS_gput_nil:ii A { #1 }
        \BNVS_gput_nil:ii V { #1 }
      }
    } {
      \BNVS_gput:nnn A { #1 } { #2 }
      \BNVS_gput:nnn L { #1 } { #4 }
      \BNVS_gput_nil:ii Z { #1 }
      \BNVS_gput_nil:ii V { #1 }
    }
  }
}
\cs_new:Npn \BNVS_exp_args:NNcv #1 #2 #3 #4 {
  \BNVS_tl_use:ni { \exp_args:NNnV #1 #2 { #3 } }
    { #4 }
}
\cs_new:Npn \BNVS_end_tl_set:ii #1 #2 {
  \BNVS_tl_use:ni {
    \BNVS_end: \BNVS_tl_set:in { #1 }
  } { #2 }
}
\BNVS_new:bpn { parse:nn } #1 #2 {
  \BNVS_begin:
  \BNVS_tl_set:in { a } { #1 }
  \BNVS_tl_put_left:cv { a } { root }
  \BNVS_name_id_n_get:vTF { a } {
    \regex_match:nnTF { \S } { #2 } {
      \peek_remove_spaces:n {
        \peek_catcode:NTF \c_group_begin_token {
          \BNVS_tl_if_empty:iF { n } {
\BNVS_warning:n { Ignoring~unexpected~suffix~.n:~#1 }
          }
          \BNVS_begin:
          \BNVS_tl_set:vv { root } { key }
          \int_set:Nn \l__bnvs_int { 0 }
          \cs_set:Npn \BNVS:nn ##1 ##2 \s_stop {
            \regex_match:nnT { \S } { ##2 } {
              \BNVS_error:n { Unexpected~value~#2 }
            }
            \keyval_parse:nnn {
              \BNVS_parse:n
            } {
              \BNVS_parse:nn
            } { ##1 }
            \BNVS_end:
          }
          \BNVS:nn
        } {
          \BNVS_tl_if_empty:iTF { n } {
            \BNVS_parse_record:vn
          } {
            \BNVS_n_parse_record:vn
          }
          { key } { #2 }
          \use_none_delimit_by_s_stop:w
        }
      }
      #2 \s_stop
    } {
      \BNVS_tl_if_empty:iTF { n } {
        \BNVS_gclear:v
      } {
        \BNVS_n_gremove:v
      }
      { key }
    }
  } {
    \BNVS_error:n { Invalid~key:~#2 }
  }
  \BNVS_end_tl_set:ii { id_last } { id_last }
}
\BNVS_new:bpn { parse_prepare:N } #1 {
  \tl_set:Nx #1 #1
  \bool_set_false:N \l__bnvs_parse_bool
  \bool_do_until:Nn \l__bnvs_parse_bool {
    \tl_if_in:NnTF #1 {%---[
    ]} {
      \regex_replace_all:nnNF { \[ ([^\]%---)
      ]*%---[(
      ) \] } { { { \1 } } } #1 {
        \bool_set_true:N \l__bnvs_parse_bool
      }
    } {
      \bool_set_true:N \l__bnvs_parse_bool
    }
  }
  \tl_if_in:NnTF #1 {%---[
  ]} {
    \BNVS_error:n { Unbalanced~%---[
    ]}
  } {
    \tl_if_in:NnT #1 { [%---]
    } {
      \BNVS_error:n { Unbalanced~[ %---]
      }
    }
  }
}
\cs_new:Npn \BNVS_end_tl_put_right:ii #1 #2 {
  \BNVS_tl_use:ni {
    \BNVS_end:
    \BNVS_tl_put_right:in { #1 }
  } { #2 }
}
\cs_new:Npn \BNVS_end_v_gput:nc #1 #2 {
  \BNVS_tl_use:ni {
    \BNVS_end:
    \BNVS_v_gput:nn { #1 }
  } { #2 }
}
\NewDocumentCommand \Beanoves { sm } {
  \tl_if_empty:NTF \@currenvir {
    \seq_gput_right:Nn \g__bnvs_def_seq { #2 }
  } {
    \tl_if_eq:NnT \@currenvir { document } {
      \BNVS_gclear:
    }
    \BNVS_begin:
    \BNVS_tl_clear:i { root }
    \int_zero:N \l__bnvs_int
    \BNVS_tl_set:in { a } { #2 }
    \tl_if_eq:NnT \@currenvir { document } {
      \seq_if_empty:NF \g__bnvs_def_seq {
        \BNVS_tl_put_left:cx { a } {
          \seq_use:Nn \g__bnvs_def_seq , ,
        }
      }
    }
    \BNVS_parse_prepare:N \l__bnvs_a_tl
    \IfBooleanTF {#1} {
      \BNVS_provide_on:
    } {
      \BNVS_provide_off:
    }
    \BNVS_tl_use:ni {
      \keyval_parse:nnn { \BNVS_parse:n } { \BNVS_parse:nn }
    } { a }
    \BNVS_end_tl_set:ii { id_last } { id_last }
    \ignorespaces
  }
}
\define@key{beamerframe}{beanoves}{\Beanoves*{#1}}
\cs_set_eq:NN \BNVS_beamer@frame \beamer@frame
\cs_set:Npn \beamer@frame < #1 > {
  \BNVS_begin:
  \BNVS_tl_clear:i { ans }
  \BNVS_scan:nNi { #1 } \BNVS_eval:ni { ans }
  \BNVS_tl_use:ni {
    \BNVS_end:
    \BNVS_beamer@frame <
  } { ans } >
}
\cs_set_eq:NN \BNVS_beamer@masterdecode \beamer@masterdecode
\cs_set:Npn \beamer@masterdecode #1 {
  \BNVS_begin:
  \BNVS_tl_clear:i { ans }
  \BNVS_scan:nNi { #1 } \BNVS_eval:ni { ans }
  \BNVS_tl_use:ni {
    \BNVS_end:
    \BNVS_beamer@masterdecode
  } { ans }
}
\BNVS_new:bpn { scan_question:T } #1 {
  \BNVS_seq_pop_left:iiT { token } { token } {
    \BNVS_tl_if_eq:vnTF { token } { ? } {
      \BNVS_scan_require_open:
      #1
    } {
      \BNVS_tl_put_right:ii { ans } { token }
    }
    \BNVS_scan_question:T { #1 }
  }
}
\BNVS_new:bpn { scan_require_open: } {
  \BNVS_seq_pop_left:iiTF { token } { token } {
    \tl_if_eq:NnTF \l__bnvs_token_tl { ( %)
    } {
        \BNVS_int_set:cn { } { 1 }
        \BNVS_tl_clear:i { query }
        \BNVS_scan_require_close:
      } {
        \BNVS_scan_require_open:
      }
    } {
    \BNVS_fatal:x {Missing~'('%---)
      ~after~a~? }
  }
}
\BNVS_new:bpn { scan_require_close: } {
  \BNVS_seq_pop_left:iiTF { token } { token } {
    \BNVS_tl_if_eq:vnTF { token } { ( %---)
    } {
      \BNVS_int_incr:c { }
      \BNVS_tl_put_right:ii { query } { token }
      \BNVS_scan_require_close:
    } {
      \BNVS_tl_if_eq:vnTF { token } { %(---
        )
      } {
        \BNVS_int_decr:c {}
        \int_compare:nNnTF { \BNVS_int_use:c {} } = 0 {
        } {
          \BNVS_tl_put_right:ii { query } { token }
          \BNVS_scan_require_close:
        }
      } {
        \BNVS_tl_put_right:ii { query } { token }
        \BNVS_scan_require_close:
      }
    }
  } {
    \BNVS_error:x { Missing~%(---
      `)' }
    \BNVS_tl_put_right:ix { query } {
      \prg_replicate:nn { \l__bnvs_int } {%(---
      )}
    }
  }
}
\BNVS_new:bpn { scan:nNi } #1 #2 #3 {
  \BNVS_begin:
  \BNVS_set:bpn { fatal:x } ##1 {
    \msg_fatal:nnx { beanoves } { :n }
      { \tl_to_str:n { #1 }:~##1}
  }
  \BNVS_set:bpn { error:x } ##1 {
    \msg_error:nnx { beanoves } { :n }
      { \tl_to_str:n { #1 }:~##1}
  }
  \BNVS_tl_set:in { scan } { #1 }
  \BNVS_tl_clear:i { ans }
  \BNVS_seq_clear:i { token }
  \regex_split:nnN { } { #1 } \l__bnvs_token_seq
  \BNVS_scan_question:T {
    \BNVS_tl_use_n:ni { #2 { ans } } { query }
  }
  \BNVS_tl_use:ni {
    \BNVS_end:
    \BNVS_tl_put_right:in { #3 }
  } { ans }
}
\cs_new:Npn \BNVS_end_kip_export:nnnccc #1 #2 #3 #4 #5 #6 {
  \BNVS_end:
  \tl_if_empty:nTF { #2 } {
    \BNVS_tl_set:in { #4 } { #1 }
    \BNVS_tl_put_left:cv { #4 } { #5 }
  } {
    \BNVS_tl_set:in { #4 } { #1 }
    \BNVS_tl_set:in { #5 } { #2 }
  }
  \BNVS_seq_set_from_flat:cn { #6 } { #3 }
}
\cs_new:Npn \BNVS_end_kip_export:iiiccc #1 #2 #3 {
  \PROBLEM
  \BNVS_seq_use_n:ni {
    \BNVS_tl_use_n:ni {
      \BNVS_tl_use_n:Ni \BNVS_end_kip_export:nnnccc { #1 }
    } { #2 }
  } { #3 }
}
\cs_new:Npn \BNVS_end_kip_export:ccc {
  \exp_args:Nnnx \BNVS_tl_use:ni {
    \BNVS_tl_use:Ni \BNVS_end_kip_export:nnnccc { key }
  } { id } {
    \BNVS_seq_use:in { path } { \q__bnvs }
  }
}
\BNVS_new_conditional:bpnn { match_pop_kip: } { T, F, TF } {
  \BNVS_match_pop_left:iTF { key } {
    \BNVS_match_pop_left:iTF { key } {
      \BNVS_match_pop_left:iTF { id } {
        \BNVS_match_pop_left:iTF { path } {
          \BNVS_seq_set_split:inv { path } { . } { path }
          \BNVS_seq_remove_all:vn { path } { }
          \prg_return_true:
        } {
          \prg_return_false:
        }
      } {
        \prg_return_false:
      }
    } {
      \prg_return_false:
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { kip:ccc } #1 #2 #3 { T, F, TF } {
  \BNVS_begin:
  \BNVS_extract_once:NiTF \c__bnvs_A_key_Z_regex { #1 } {
    \BNVS_match_pop_kip:TF {
      \BNVS_end_kip_export:ccc { #1 } { #2 } { #3 }
      \prg_return_true:
    } {
      \BNVS_end:
      \prg_return_false:
    }
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new:bpn { kip_x_path_resolve:TFF } #1 #2 {
  \BNVS_kip_x_path_resolve:TF {
    \BNVS_seq_if_empty:iTF { path } { #1 } { #2 }
  }
}
\BNVS_new:bpn { end_kip_export: } {
  \exp_args:Nnnx
  \BNVS_tl_use:ni {
    \BNVS_tl_use:Ni \BNVS_end_kip_export:nnnccc { key }
  } { id } {
    \BNVS_seq_use:in { path } { \q__bnvs }
  } { key } { id } { path }
}
\BNVS_new:bpn { kip_x_path_resolve:nFF } #1 #2 #3 {
  \BNVS_get:nvcTF #1 { a } { b } {
    \BNVS_kip:cccTF { b } { id } { path } {
      \BNVS_tl_set_eq:ii { key } { b }
      \BNVS_seq_merge:cc { path } { b }
      \BNVS_seq_clear:i { b }
      \BNVS_seq_set_eq:vv { a } { path }
      \BNVS_kip_x_path_resolve_loop_or_end_return:
    } {
      \BNVS_seq_if_empty:iTF { b } {
        \BNVS_tl_set_eq:ii { key } { b }
        \BNVS_seq_clear:i { path }
        \BNVS_seq_clear:i { a }
        \BNVS_kip_x_path_resolve_loop_or_end_return:
      } {
        #2
      }
    }
  } {
    #3
  }
}
\BNVS_new:bpn { kip_x_path_resolve_VALZ_loop_or_end_return:F } #1 {
  \BNVS_kip_x_path_resolve:nFF V { #1 } {
    \BNVS_kip_x_path_resolve:nFF A { #1 } {
      \BNVS_kip_x_path_resolve:nFF L { #1 } { #1 }
    }
  }
}
\BNVS_new:bpn { kip_x_path_resolve_end_return_true: } {
  \BNVS_seq_pop_left:iiTF { path } { a } {
    \BNVS_seq_if_empty:iTF { path } {
      \BNVS_tl_clear:i { b }
      \BNVS_index_can:vTF { key } {
        \BNVS_index_append:vvcTF { key } { a } { b } {
          \BNVS_tl_set:vv { key } { b }
        } {
          \BNVS_tl_set:vv { key } { a }
        }
      } {
        \BNVS_tl_set:vv { key } { a }
      }
    } {
      \BNVS_error:x { Path~too~long~.\BNVS_tl_use:i { a }
        .\BNVS_seq_use:in { path } . }
    }
  } {
    \BNVS_V_resolve:vvT { key } { key } {}
  }
  \BNVS_end_kip_export:
  \prg_return_true:
}
\BNVS_new_conditional:bpnn { kip_x_path_resolve: } { T, F, TF } {
  \BNVS_begin:
  \BNVS_seq_set_eq:vv { a } { path }
  \BNVS_seq_clear:i { b }
  \BNVS_kip_x_path_resolve_loop_or_end_return:
}
\BNVS_new:bpn { kip_x_path_resolve_loop_or_end_return: } {
  \BNVS_call:TF {
    \BNVS_tl_set_eq:ii { a } { key }
    \BNVS_seq_if_empty:iTF { a } {
      \BNVS_kip_x_path_resolve_VALZ_loop_or_end_return:F {
        \BNVS_kip_x_path_resolve_end_return_true:
      }
    } {
      \BNVS_tl_put_right:ix { a } { . \BNVS_seq_use:in { a } . }
      \BNVS_kip_x_path_resolve_VALZ_loop_or_end_return:F {
        \BNVS_seq_pop_right:ccT { a } { c } {
          \BNVS_seq_put_left:vv { b } { c }
        }
        \BNVS_kip_x_path_resolve_loop_or_end_return:
      }
    }
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new:bpn { kip_n_path_resolve_b_or_end_return: } {
  \BNVS_kip:cccTF { b } { id } { path } {
    \BNVS_tl_set_eq:ii { key } { b }
    \BNVS_seq_merge:cc { path } { b }
    \BNVS_seq_set_eq:vv { a } { path }
    \BNVS_seq_clear:i { b }
    \BNVS_kip_n_path_resolve_loop_or_end_return:
  } {
    \BNVS_tl_if_empty:iTF { b } {
      \BNVS_seq_pop_right:ccTF { a } { c } {
        \BNVS_seq_put_left:vv { b } { c }
        \BNVS_kip_n_path_resolve_loop_or_end_return:
      } {
        \BNVS_kip_n_path_resolve_end_return_true:
      }
    } {
      \BNVS_if_resolve:iiTF { b } { a } {
        \BNVS_end_tl_put_right:ii { ans } { a }
        \prg_return_true:
      } {
        \BNVS_kip_n_path_resolve_end_return_false:
      }
    }
  }
}
\cs_new:Npn \BNVS_error_end_return_false:n #1 {
  \BNVS_error:x { #1 }
  \BNVS_end:
  \prg_return_false:
}
\cs_new:Npn \BNVS_end_unreachable_return_false:n #1 {
  \BNVS_error_end_return_false:n { UNREACHABLE/#1 }
}
\BNVS_new:bpn { kip_n_path_resolve_or_end_return:nF } #1 #2 {
  \BNVS_get:nvcTF { #1 } { a } { b } {
    \BNVS_quark_if_nil:iTF { b } {
      \BNVS_cache_get:nvcTF { #1 } { a } { b } {
        \BNVS_kip_n_path_resolve_b_or_end_return:
      } {
        \BNVS_error_end_return_false:n { Circular~definition... }
      }
    } {
      \BNVS_kip_n_path_resolve_b_or_end_return:
    }
  } {
    #2
  }
}
\BNVS_new:bpn { kip_n_path_resolve_VALZ_loop_or_end_return: } {
  \BNVS_kip_n_path_resolve_or_end_return:nF V {
    \BNVS_kip_n_path_resolve_or_end_return:nF A {
      \BNVS_kip_n_path_resolve_or_end_return:nF L {
        \BNVS_kip_n_path_resolve_or_end_return:nF Z {
          \BNVS_seq_pop_right:ccTF { a } { c } {
            \BNVS_seq_put_left:vv { b } { c }
            \BNVS_kip_n_path_resolve_loop_or_end_return:
          } {
            \BNVS_kip_n_path_resolve_end_return_true:
          }
        }
      }
    }
  }
}
\BNVS_new:bpn { kip_n_path_resolve_end_return_false: } {
  \BNVS_end:
  \prg_return_false:
}
\BNVS_new:bpn { kip_n_path_resolve_end_return_true: } {
  \BNVS_end_kip_export:
  \prg_return_true:
}
\BNVS_new:bpn { kip_n_path_resolve_loop_or_end_return: } {
  \BNVS_call:TF {
    \BNVS_tl_set_eq:ii { a } { key }
    \BNVS_seq_if_empty:iF { a } {
      \BNVS_tl_put_right:ix { a } { . \BNVS_seq_use:in { a } . }
    }
    \BNVS_kip_n_path_resolve_VALZ_loop_or_end_return:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new:bpn { kip_if_resolve_end_export: } {
  \BNVS_seq_pop_right:ccTF { a } { c } {
    \BNVS_seq_put_left:vv { b } { c }
    \BNVS_kip_if_resolve_end_return:
   } {
    \BNVS_end_kip_export:vvvccc { a } { id } { a } { key } { id } { path }
    \prg_return_true:
  }
}
\BNVS_new:bpn { kip_if_resolve_end_return: } {
  \BNVS_call:TF {
    \BNVS_tl_set_eq:ii { a } { key }
    \BNVS_seq_if_empty:iF { a } {
      \BNVS_tl_put_right:ix { a } { . \BNVS_seq_use:in { a } . }
    }
    \BNVS_kip_get:vcccTF { a } { a } { id } { a } {
      \BNVS_seq_use:nnc {
        \BNVS_seq_merge:cnn { a } { \q__bnvs }
      } { \q__bnvs } { a }
      \BNVS_kip_if_resolve_end_return:
    } {
      \BNVS_V_resolve:vvTF { a } { c } {
        \BNVS_extract_once:NiTF \c__bnvs_A_key_Z_regex { c } {
          \BNVS_match_pop_left:iTF { key } {
            \BNVS_match_pop_left:iTF { key } {
              \BNVS_match_pop_left:iTF { id } {
                \BNVS_match_pop_left:iTF { path } {
                  \BNVS_seq_set_split:inv { path } { . } { path }
                  \BNVS_seq_remove_all:vn { path } { }
                  \BNVS_kip_gput:vvvv { a } { key } { id } { path }
                  \BNVS_seq_set_eq:vv { a } { path }
                  \BNVS_seq_clear:i { b }
                  \BNVS_kip_if_resolve_end_return:
                } {
                  \BNVS_fatal:n { LOGICALLY_UNREACHABLE_A_key_n_Z/path }
                }
              } {
                \BNVS_fatal:n { LOGICALLY_UNREACHABLE_A_key_n_Z/id }
              }
            } {
              \BNVS_fatal:n { LOGICALLY_UNREACHABLE_A_key_n_Z/key }
            }
          } {
            \BNVS_fatal:n { LOGICALLY_UNREACHABLE_A_key_n_Z }
          }
        } {
          \BNVS_kip_if_resolve_end_export:
        }
      } {
        \BNVS_kip_if_resolve_end_export:
      }
    }
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { kip_if_resolve: } { T, F, TF } {
    \BNVS_begin:
    \BNVS_tl_set_eq:ii { a } { key }
    \BNVS_seq_if_empty:iF { a } {
      \BNVS_tl_put_right:ix { a } { . \BNVS_seq_use:in { a } . }
    }
    \BNVS_kip_if_resolve_end_return:
}
\BNVS_new_conditional:bpnn { kip_if_resolve:n } #1 { T, F, TF } {
  \BNVS_kip_get:ncccTF { #1 } { key } { id } { path } {
    \prg_return_true:
  } {
    \BNVS_extract_once:NnTF \c__bnvs_A_key_Z_regex { #1 } {
      \BNVS_match_pop_left:iTF { key } {
        \BNVS_match_pop_left:iTF { key } {
          \BNVS_match_pop_left:iTF { id } {
            \BNVS_match_pop_left:iTF { path } {
              \BNVS_seq_set_split:inv { path } { . } { path }
              \BNVS_seq_remove_all:vn { path } { }
              \BNVS_begin:
              \BNVS_seq_set_eq:vv { a } { path }
              \BNVS_seq_clear:i { b }
              \BNVS_kip_if_resolve_end_return:
            } {
              \BNVS_error:n { LOGICALLY_UNREACHABLE_A_key_n_Z/path }
              \prg_return_false:
            }
          } {
            \BNVS_error:n { LOGICALLY_UNREACHABLE_A_key_n_Z/id }
            \prg_return_false:
          }
        } {
          \BNVS_error:n { LOGICALLY_UNREACHABLE_A_key_n_Z/key }
          \prg_return_false:
        }
      } {
        \BNVS_error:n { LOGICALLY_UNREACHABLE_A_key_n_Z }
        \prg_return_false:
      }
    } {
      \prg_return_false:
    }
  }
}
\BNVS_new_conditional:bpnn { kip_n_path_resolve: } { T, F, TF } {
  \BNVS_begin:
  \BNVS_seq_set_eq:vv { a } { path }
  \BNVS_seq_clear:i { b }
  \BNVS_kip_n_path_resolve_loop_or_end_return:
}
\BNVS_new:bpn { round_ans:n } #1 {
  \tl_if_empty:nTF { #1 } {
    \BNVS_tl_put_right:in { ans } { 0 }
  } {
    \BNVS_tl_put_right:ix { ans } { \fp_eval:n { round(#1) } }
  }
}
\BNVS_new:bpn { round:N } #1 {
  \tl_if_empty:NTF #1 {
    \tl_set:Nn #1 { 0 }
  } {
    \tl_set:Nx #1 { \fp_eval:n { round(#1) } }
  }
}
\BNVS_new:bpn { round:c } {
  \BNVS_tl_use:Ni \BNVS_round:N
}
\cs_new:Npn \BNVS_end_return_false: {
  \BNVS_end:
  \prg_return_false:
}
\cs_new:Npn \BNVS_end_return_false:x #1 {
  \BNVS_error:x { #1 }
  \BNVS_end_return_false:
}
\BNVS_new:bpn { end_tl_put_right:ii } #1 #2 {
  \BNVS_tl_use:ni {
    \BNVS_end:
    \BNVS_tl_put_right:in { #2 }
  } { #1 }
}
\BNVS_new:bpn { V_resolve_return:iiiT } #1 #2 #3 #4 {
  \BNVS_tl_if_empty:iTF { #3 } {
    \prg_return_false:
  } {
    \BNVS_cache_gput:nni V { #2 } { #3 }
    #4
    \prg_return_true:
  }
}
\BNVS_new_conditional:bpnn { V_resolve:in } #1 #2 { T, F, TF } {
  \BNVS_cache_get:nniTF V { #2 } { #1 } {
    \prg_return_true:
  } {
    \BNVS_get:nniTF V { #2 } { #1 } {
      \BNVS_quark_if_nil:iTF { #1 } {
        \BNVS_gput_no_value:nn V { #2 }
        \BNVS_A_resolve:inTF { #1 } { #2 } {
          \BNVS_V_resolve_return:iiiT A { #2 } { #1 } {
            \BNVS_gput_nil:ii V { #2 }
          }
        } {
          \BNVS_Z_resolve:inTF { #1 } { #2 } {
            \BNVS_V_resolve_return:iiiT Z { #2 } { #1 } {
              \BNVS_gput_nil:ii V { #2 }
            }
          } {
            \BNVS_gput_nil:ii V { #2 }
            \prg_return_false:
          }
        }
      } {
        \BNVS_quark_if_no_value:iTF { #1 } {
          \BNVS_fatal:n {Circular~definition:~#2}
        } {
          \BNVS_gput_no_value:nnv V { #2 } { #1 }
          \BNVS_if_resolve:iiTF { #2 } { #2 } {
            \BNVS_V_resolve_return:iiiT V { #1 } { #2 } {
              \BNVS_gput_nil:ii V { #1 }
            }
          } {
            \BNVS_gput_nil:ii V { #1 }
            \prg_return_false:
          }
        }
      }
    } {
      \prg_return_false:
    }
  }
}
\BNVS_new_conditional:bpnn { V_append:in } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_V_resolve:inTF { #1 } { #2 } {
    \BNVS_end_tl_put_right:ii { #1 } { #1 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_true:
  }
}
\BNVS_new_conditional_wrap:btn { V_append } { tl } { T, F, TF }
\BNVS_new_conditional:bpnn { A_resolve:in } #1 #2 { T, F, TF } {
  \BNVS_cache_get:nniTF A { #1 } { #2 } {
    \prg_return_true:
  } {
    \BNVS_get:nniTF A { #1 } { #2 } {
      \BNVS_quark_if_nil:iTF { #2 } {
        \BNVS_gput_no_value:nn A { #1 }
        \BNVS_Z_resolve:inTF { #1 } { #2 } {
          \BNVS_tl_put_right:in { #2 } { - }
          \BNVS_L_append:ncTF { #1 } { #2 } {
            \BNVS_tl_put_right:in { #2 } { + 1 }
            \BNVS_round:c { #2 }
            \BNVS_tl_if_empty:iTF { #2 } {
              \BNVS_gput_nil:ii A { #1 }
              \prg_return_false:
            } {
              \BNVS_gput_nil:ii A { #1 }
              \BNVS_cache_gput:nni A { #1 } { #2 }
              \prg_return_true:
            }
          } {
            \BNVS_error:n {
Unavailable~length~for~#1~(\token_to_str:N\BNVS_A_resolve:inTF/2) }
            \BNVS_gput_nil:ii A { #1 }
            \prg_return_false:
          }
        } {
          \BNVS_error:n {
Unavailable~last~for~#1~(\token_to_str:N\BNVS_A_resolve:inTF/1) }
          \BNVS_gput_nil:ii A { #1 }
          \prg_return_false:
        }
      } {
        \BNVS_gput_nil:ii A { #1 }
        \BNVS_quark_if_no_value:iTF { #2 } {
          \BNVS_fatal:n {Circular~definition:~#1}
        } {
          \bnvs_gput_no_value:nnv A { #1 } { #2 }
          \BNVS_if_resolve:iiTF { #2 } { #2 } {
            \BNVS_cache_gput:nni A { #1 } { #2 }
            \prg_return_true:
          } {
            \prg_return_false:
          }
        }
      }
    } {
      \prg_return_false:
    }
  }
}
\BNVS_new_conditional:bpnn { A_append:nc } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_A_resolve:inTF { #1 } { #2 } {
    \BNVS_end_tl_put_right:ii { #2 } { #2 }
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { Z_resolve:in } #1 #2 { T, F, TF } {
  \BNVS_cache_get:nniTF Z { #1 } { #2 } {
    \prg_return_true:
  }  {
    \BNVS_get:nniTF Z { #1 } { #2 } {
      \BNVS_quark_if_nil:iTF { #2 } {
        \BNVS_gput_no_value:nn Z { #1 }
        \BNVS_A_resolve:inTF { #1 } { #2 } {
          \BNVS_tl_put_right:in { #2 } { + }
          \BNVS_L_append:ncTF { #1 } { #2 } {
            \BNVS_tl_put_right:in { #2 } { - 1 }
            \BNVS_round:c { #2 }
            \BNVS_cache_gput:nni Z { #1 } { #2 }
            \BNVS_gput_nil:ii Z { #1 }
            \prg_return_true:
          } {
            \BNVS_error:x {
 Unavailable~length~for~#1~(\token_to_str:N \BNVS_Z_resolve:inTF/1) }
            \BNVS_gput_nil:ii Z { #1 }
            \prg_return_false:
          }
        } {
          \BNVS_error:x {
Unavailable~first~for~#1~(\token_to_str:N \BNVS_Z_resolve:inTF/1) }
          \BNVS_gput_nil:ii Z { #1 }
          \prg_return_false:
        }
      } {
        \BNVS_quark_if_no_value:iTF { #2 } {
          \BNVS_fatal:n {Circular~definition:~#1}
        } {
          \BNVS_if_resolve:iiTF { #2 } { #2 } {
            \BNVS_cache_gput:nni Z { #1 } { #2 }
            \prg_return_true:
          } {
            \prg_return_false:
          }
        }
      }
    } {
      \prg_return_false:
    }
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_Z_resolve:inTF { T, F, TF }
\BNVS_new_conditional:bpnn { Z_append:nc } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_Z_resolve:inTF { #1 } { #2 } {
    \BNVS_end_tl_put_right:ii { #2 } { #2 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_Z_append:ncTF { T, F, TF }
\BNVS_new_conditional:bpnn { L_resolve:ni } #1 #2 { T, F, TF } {
  \BNVS_cache_get:nniTF L { #1 } { #2 } {
    \prg_return_true:
  } {
    \BNVS_get:nniTF L { #2 } { #1 } {
      \BNVS_quark_if_nil:iTF { #2 } {
        \BNVS_gput_no_value:nn L { #1 }
        \BNVS_Z_resolve:inTF { #1 } { #2 } {
          \BNVS_tl_put_right:in { #2 } { - }
          \BNVS_A_append:ncTF { #1 } { #2 } {
            \BNVS_tl_put_right:in { #2 } { + 1 }
            \BNVS_round:c { #2 }
            \BNVS_gput_nil:ii L { #1 }
            \BNVS_cache_gput:nni L { #1 } { #2 }
            \prg_return_true:
          } {
            \BNVS_error:n {
Unavailable~first~for~#1~(\BNVS_L_resolve:niTF/2) }
            \prg_return_false:
          }
        } {
          \BNVS_error:n {
Unavailable~last~for~#1~(\BNVS_L_resolve:niTF/1) }
          \prg_return_false:
        }
      } {
        \BNVS_quark_if_no_value:iTF { #2 } {
          \BNVS_fatal:n {Circular~definition:~#1}
        } {
          \BNVS_if_resolve:iiTF { #2 } { #2 } {
            \BNVS_cache_gput:nni L { #1 } { #2 }
            \prg_return_true:
          } {
            \prg_return_false:
          }
        }
      }
    } {
      \prg_return_false:
    }
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_L_resolve:niTF { T, F, TF }
\BNVS_new_conditional:bpnn { L_append:nc } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_L_resolve:niTF { #1 } { #2 } {
    \BNVS_end_tl_put_right:ii { #2 } { #2 }
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_L_append:ncTF { T, F, TF }
\BNVS_new_conditional:bpnn { range_append:nc } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_A_resolve:inTF { a } { #1 } {
    \BNVS_tl_use:Ni \int_compare:nNnT { a } < 0 {
      \BNVS_tl_set:in { a } { 0 }
    }
    \BNVS_Z_resolve:inTF { #1 } { b } {
      \BNVS_tl_use:Ni \int_compare:nNnT { b } < 0 {
        \BNVS_tl_set:in { b } { 0 }
      }
      \BNVS_tl_put_right:in { a } { - }
      \BNVS_tl_put_right:ii { a } { b }
      \BNVS_end_tl_put_right:ii { #2 } { a }
      \prg_return_true:
    } {
      \BNVS_end_tl_put_right:ii { #2 } { a }
      \BNVS_tl_put_right:in { #2 } { - }
      \prg_return_true:
    }
  } {
    \BNVS_Z_resolve:inTF { #1 } { b } {
      \BNVS_tl_use:Ni \int_compare:nNnT { b } < 0 {
        \BNVS_tl_set:in { b } { 0 }
      }
      \BNVS_tl_put_left:in { b } { - }
      \BNVS_end_tl_put_right:ii { #2 } { b }
      \prg_return_true:
    } {
      \BNVS_V_resolve:inTF { #1 } { b } {
      \BNVS_tl_use:Ni \int_compare:nNnT { b } < 0 {
        \BNVS_tl_set:in { b } { 0 }
      }
        \BNVS_end_tl_put_right:ii { #2 } { b }
        \BNVS_tl_put_right:in { #2 } { - }
        \prg_return_true:
      } {
        \BNVS_end:
        \prg_return_false:
      }
    }
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_range_append:ncTF { T, F, TF }
\BNVS_new_conditional:bpnn { range_resolve:ni } #1 #2 { T, F, TF } {
  \BNVS_tl_clear:i { #2 }
  \BNVS_range_append:ncTF { #1 } { #2 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_range_resolve:niTF { T, F, TF }
\BNVS_new_conditional:bpnn { previous_resolve:ni } #1 #2 { T, F, TF } {
  \BNVS_cache_get:nniTF P { #1 } { #2 } {
    \prg_return_true:
  } {
    \BNVS_A_resolve:inTF { #1 } { #2 } {
      \BNVS_tl_put_right:in { #2 } { -1 }
      \BNVS_round:c { #2 }
      \BNVS_cache_gput:nni P { #1 } { #2 }
      \prg_return_true:
    } {
      \prg_return_false:
    }
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_previous_resolve:niTF { T, F, TF }
\BNVS_new_conditional:bpnn { previous_append:nc } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_previous_resolve:niTF { #1 } { #2 } {
    \BNVS_end_tl_put_right:ii { #2 } { #2 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_previous_append:ncTF { T, F, TF }
\BNVS_new_conditional:bpnn { next_resolve:ni } #1 #2 { T, F, TF } {
  \BNVS_cache_get:nniTF N { #2 } { #1 } {
    \prg_return_true:
  } {
    \BNVS_Z_resolve:inTF { #1 } { #2 } {
      \BNVS_tl_put_right:in { #1 } { +1 }
      \BNVS_round:c { #2 }
      \BNVS_cache_gput:nni N { #2 } { #1 }
      \prg_return_true:
    } {
      \prg_return_false:
    }
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_next_append:ncTF { T, F, TF }
\BNVS_new_conditional:bpnn { next_append:nc } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_next_resolve:niTF { #1 } { #2 } {
    \BNVS_end_tl_put_right:ii { #2 } { #2 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_true:
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_next_append:ncTF { T, F, TF }
\BNVS_new_conditional:bpnn { v_resolve:ni } #1 #2 { T, F, TF } {
  \BNVS_v_get:niTF { #1 } { #2 } {
    \BNVS_quark_if_no_value:iTF { #2 } {
      \BNVS_fatal:n {Circular~definition:~#1}
      \prg_return_false:
    } {
      \prg_return_true:
    }
  } {
    \BNVS_v_gput:nn { #1 } { \q_no_value }
    \BNVS_V_resolve:inTF { #1 } { #2 } {
      \BNVS_v_gput:nv { #1 } { #2 }
      \prg_return_true:
    } {
      \BNVS_A_resolve:inTF { #1 } { #2 } {
        \BNVS_v_gput:nv { #1 } { #2 }
        \prg_return_true:
      } {
        \BNVS_Z_resolve:inTF { #1 } { #2 } {
        \BNVS_v_gput:nv { #1 } { #2 }
          \prg_return_true:
        } {
          \BNVS_v_gremove:n { #1 }
          \prg_return_false:
        }
      }
    }
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_v_resolve:niTF { T, F, TF }
\BNVS_new_conditional:bpnn { v_append:nc } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_v_resolve:niTF { #1 } { #2 } {
    \BNVS_end_tl_put_right:ii { #2 } { #2 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_v_append:ncTF { T, F, TF }
\BNVS_new_conditional:bpnn { index_can:n } #1 { p, T, F, TF } {
  \bool_if:nTF {
       \BNVS_if_in_p:nn V { #1 }
    || \BNVS_if_in_p:nn A { #1 }
    || \BNVS_if_in_p:nn Z { #1 }
  } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { index_can:v } #1 { p, T, F, TF } {
  \BNVS_tl_use:Ni \BNVS_index_can:nTF { #1 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { index_resolve:nnc } #1 #2 #3 { T, F, TF } {
  \exp_args:Nx \BNVS_V_resolve:inTF { #1.#2 } { #3 } {
      \prg_return_true:
  } {
    \BNVS_A_resolve:inTF { #1 } { #3 } {
      \BNVS_tl_put_right:in { #3 } { + #2 - 1 }
         \BNVS_round:c { #3 }
      \prg_return_true:
    } {
      \BNVS_Z_resolve:inTF { #1 } { #3 } {
        \BNVS_tl_put_right:in { #3 } { + #2 - 1 }
          \BNVS_round:c { #3 }
        \prg_return_true:
      } {
        \BNVS_V_resolve:inTF { #1 } { #3 } {
          \BNVS_tl_put_right:in { #3 } { + #2 - 1 }
            \BNVS_round:c { #3 }
          \prg_return_true:
        } {
        \prg_return_false:
        }
      }
  }
  }
}
\BNVS_new_conditional:bpnn { index_resolve:nvv } #1 #2 #3 { T, F, TF } {
  \BNVS_tl_use:ni {
    \BNVS_index_resolve:nncTF { #1 }
  } { #2 } { #3 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { index_resolve:vvc } #1 #2 #3 { T, F, TF } {
  \BNVS_tl_use:ni {
    \BNVS_tl_use:Ni \BNVS_index_resolve:nncTF { #1 }
  } { #2 } { #3 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { index_append:nnc } #1 #2 #3 { T, F, TF } {
  \BNVS_begin:
  \BNVS_index_resolve:nncTF { #1 } { #2 } { #3 } {
    \BNVS_end_tl_put_right:ii { #3 } { #3 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { index_append:vvc } #1 #2 #3 { T, F, TF } {
  \BNVS_tl_use:ni {
    \BNVS_tl_use:Ni \BNVS_index_append:nncTF { #1 }
  } { #2 } { #3 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { n_resolve:ni } #1 #2 { T, F, TF } {
  \BNVS_n_get:niF { #1 } { #2 } {
    \BNVS_tl_set:in { #2 } { 1 }
    \BNVS_n_gput:nn { #1 } { 1 }
  }
  \prg_return_true:
}
\BNVS_new_conditional:bpnn { n_append:ni } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_n_resolve:niTF { #1 } { #2 } {
    \BNVS_end_tl_put_right:ii { #2 } { #2 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional_ia_wrap:Nn \BNVS_n_append:niTF { T, F, TF }
\BNVS_new_conditional:bpnn { n_index_resolve:ni } #1 #2 { T, F, TF } {
  \BNVS_n_resolve:niTF { #1 } { #2 } {
    \BNVS_index_resolve:nvvTF { #1 } { #2 } { #2 } {
      \prg_return_true:
    } {
      \prg_return_false:
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { n_index_resolve:nnv } #1 #2 #3 { T, F, TF } {
  \BNVS_n_resolve:niTF { #1 } { #3 } {
    \BNVS_tl_put_left:in { #3 } { #2. }
    \BNVS_if_resolve:iiTF { #3 } { #3 } {
      \prg_return_true:
    } {
      \prg_return_false:
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { n_index_append:ni } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_n_index_resolve:niTF { #1 } { #2 } {
    \BNVS_end_tl_put_right:ii { #2 } { #2 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { n_index_append:nni } #1 #2 #3 { T, F, TF } {
  \BNVS_begin:
  \BNVS_n_index_resolve:nnvTF { #1 } { #2 } { #3 } {
    \BNVS_end_tl_put_right:ii { #3 } { #3 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional_ii_wrap:Nntt \BNVS_n_index_append:nni { tl } { tl }
\BNVS_new_conditional_tl_vvv:cn { n_index_append } { T, F, TF }
\BNVS_new_conditional:bpnn { v_incr_resolve:nnv } #1 #2 #3 { T, F, TF } {
  \BNVS_if_resolve:niTF { #2 } { #3 } {
    \BNVS_tl_use:Ni \int_compare:nNnTF { #3 } = 0 {
      \BNVS_v_resolve:niTF { #1 } { #3 } {
        \prg_return_true:
      } {
        \prg_return_false:
      }
    } {
      \BNVS_tl_put_right:in { #3 } { + }
      \BNVS_v_append:ncTF { #1 } { #3 } {
        \BNVS_round:c { #3 }
        \BNVS_v_gput:nv { #1 } { #3 }
        \prg_return_true:
      } {
        \prg_return_false:
      }
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { v_incr_append:nnv } #1 #2 #3 { T, F, TF } {
  \BNVS_begin:
  \BNVS_v_incr_resolve:nnvTF { #1 } { #2 } { #3 } {
    \BNVS_end_tl_put_right:ii { #3 } { #3 }
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional_tl_vvv:cn { v_incr_append } { T, F, TF }
\BNVS_new_conditional:bpnn { v_post_resolve:nnv } #1 #2 #3 { T, F, TF } {
  \BNVS_v_resolve:niTF { #1 } { #3 } {
    \BNVS_begin:
    \BNVS_if_resolve:niTF { #2 } { a } {
      \BNVS_tl_use:Ni \int_compare:nNnTF { a } = 0 {
        \BNVS_end:
        \prg_return_true:
      } {
        \BNVS_tl_put_right:in { a } { + }
        \BNVS_tl_put_right:ii { a } { #3 }
        \BNVS_round:c { a }
        \BNVS_end_v_gput:nc { #1 } { a }
        \prg_return_true:
      }
    } {
      \BNVS_end:
      \prg_return_false:
    }
  } {
      \prg_return_false:
  }
}
\BNVS_new_conditional_tl_vvv:cn { v_post_resolve } { T, F, TF }
\BNVS_new_conditional:bpnn { v_post_append:nnv } #1 #2 #3 { T, F, TF } {
  \BNVS_begin:
  \BNVS_v_post_resolve:nnvTF { #1 } { #2 } { #3 } {
    \BNVS_end_tl_put_right:ii { #3 } { #3 }
    \prg_return_true:
  } {
    \prg_return_true:
  }
}
\BNVS_new_conditional_vnv:cn { v_post_append } { T, F, TF }
\BNVS_new_conditional_tl_vvv:cn { v_post_append } { T, F, TF }
\BNVS_new_conditional:bpnn { n_incr_resolve:nnnv } #1 #2 #3 #4 { T, F, TF } {
  \BNVS_if_resolve:niTF { #3 } { #4 } {
    \BNVS_tl_use:Ni \int_compare:nNnTF { #4 } = 0 {
      \BNVS_n_resolve:niTF { #1 } { #4 } {
        \BNVS_index_resolve:nvvTF { #1 } { #4 } { #4 } {
          \prg_return_true:
        } {
          \prg_return_false:
        }
      } {
        \prg_return_false:
      }
    } {
      \BNVS_tl_put_right:in { #4 } { + }
      \BNVS_n_append:niTF { #1 } { #4 } {
        \BNVS_round:c { #4 }
        \BNVS_n_gput:nv { #1 } { #4 }
        \BNVS_index_resolve:nvvTF { #2 } { #4 } { #4 } {
          \prg_return_true:
        } {
          \prg_return_false:
        }
      } {
        \prg_return_false:
      }
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { n_incr_resolve:nnv } #1 #2 #3 { T, F, TF } {
  \BNVS_if_resolve:niTF { #2 } { #3 } {
    \BNVS_tl_use:Ni \int_compare:nNnTF { #3 } = 0 {
      \BNVS_n_resolve:niTF { #1 } { #3 } {
        \BNVS_index_resolve:nvvTF { #1 } { #3 } { #3 } {
          \prg_return_true:
        } {
          \prg_return_false:
        }
      } {
        \prg_return_false:
      }
    } {
      \BNVS_tl_put_right:in { #3 } { + }
      \BNVS_n_append:niTF { #1 } { #3 } {
        \BNVS_round:c { #3 }
        \BNVS_n_gput:nv { #1 } { #3 }
        \BNVS_index_resolve:nvvTF { #1 } { #3 } { #3 } {
          \prg_return_true:
        } {
          \prg_return_false:
        }
      } {
        \prg_return_false:
      }
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional_vnv:cn { n_incr_resolve } { T, F, TF }
\BNVS_new_conditional_tl_vvv:cn { n_incr_resolve } { T, F, TF }
\BNVS_new_conditional:bpnn { n_incr_append:nnnv } #1 #2 #3 #4 { T, F, TF } {
  \BNVS_begin:
  \BNVS_n_incr_resolve:nnnvTF { #1 } { #2 } { #3 } { #4 }{
    \BNVS_end_tl_put_right:ii { #4 } { #4 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional_vvnv:cn { n_incr_append } { T, F, TF }
\BNVS_new_conditional_vvvv:cn { n_incr_append } { T, F, TF }
\BNVS_new_conditional:bpnn { n_incr_append:nnv } #1 #2 #3 { T, F, TF } {
  \BNVS_begin:
  \BNVS_n_incr_resolve:nnvTF { #1 } { #2 } { #3 } {
    \BNVS_end_tl_put_right:ii { #3 } { #3 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional_vnv:cn { n_incr_append } { T, F, TF }
\BNVS_new_conditional_tl_vvv:cn { n_incr_append } { T, F, TF }
\BNVS_new_conditional:bpnn { n_post_resolve:nni } #1 #2 #3 { T, F, TF } {
  \BNVS_n_resolve:niTF { #1 } { #3 } {
    \BNVS_begin:
    \BNVS_if_resolve:niTF { #2 } { #3 } {
      \BNVS_tl_use:Ni \int_compare:nNnTF { #3 } = 0 {
        \BNVS_end:
        \BNVS_index_resolve:nvvTF { #1 } { #3 } { #3 } {
          \prg_return_true:
        } {
          \prg_return_false:
        }
      } {
        \BNVS_tl_put_right:in { #3 } { + }
        \BNVS_n_append:niTF { #1 } { #3 } {
          \BNVS_round:c { #3 }
          \BNVS_n_gput:nv { #1 } { #3 }
          \BNVS_end:
          \BNVS_index_resolve:nvvTF { #1 } { #3 } { #3 } {
            \prg_return_true:
          } {
            \prg_return_false:
          }
        } {
          \BNVS_end:
          \prg_return_false:
        }
      }
    } {
      \BNVS_end:
      \prg_return_false:
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { n_post_append:nni } #1 #2 #3 { T, F, TF } {
  \BNVS_begin:
  \BNVS_n_post_resolve:nniTF { #1 } { #2 } { #3 } {
    \BNVS_end_tl_put_right:ii { #3 } { #3 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional_i_wrap:Nnt \BNVS_n_post_append:nni { T, F, TF } { tl }
\BNVS_new_conditional_ii_wrap:Nntt \BNVS_n_post_append:nni { T, F, TF } { tl } { tl }
\BNVS_new:bpn { round_ans: } {
  \BNVS_round:c { ans }
}
\BNVS_new:bpn { path_resolve_n:TFF } #1 #2 {
  \BNVS_kip_n_path_resolve:TF {
    \BNVS_seq_if_empty:iTF { path } { #1 } { #2 }
  }
}
\BNVS_new:bpn { path_resolve_n:TF } #1 #2 {
  \BNVS_path_resolve_n:TFF {
    #1
  } {
    #2
  } {
    \BNVS_if_resolve_end_return_false:n {
      Unknown~dotted~path
    }
  }
}
\BNVS_new:bpn { path_resolve_n:T } #1 {
  \BNVS_path_resolve_n:TFF {
    #1
  } {
    \BNVS_if_resolve_end_return_false:n {
      Too~many~dotted~components
    }
  } {
    \BNVS_if_resolve_end_return_false:n {
      Unknown~dotted~path
    }
  }
}
\BNVS_new:bpn { resolve_x:T } #1 {
  \BNVS_kip_x_path_resolve:TFF {
    #1
  } {
    \BNVS_if_resolve_end_return_false:n {
      Too~many~dotted~components
    }
  } {
    \BNVS_if_resolve_end_return_false:n { Unknown~dotted~path }
  }
}
\BNVS_new_conditional:bpnn { path_pop_right:c } #1 { T, F, TF } {
  \BNVS_seq_pop_right:ccTF { path } { #1 }
    { \prg_return_true: } { \prg_return_false: }
}
\BNVS_new:bpn { if_resolve_end_return_false:n } #1 {
  \BNVS_end:
  \prg_return_false:
}
\BNVS_new:bpn { if_resolve_pop_kip_complete: } {
  \BNVS_tl_if_blank:vT { id } {
    \BNVS_tl_put_left:cv { key } { id_last }
    \BNVS_tl_set:vv { id } { id_last }
  }
  \BNVS_tl_if_blank:vTF { path } {
    \BNVS_seq_clear:i { path }
  } {
    \BNVS_seq_set_split:inv { path } { . } { path }
    \BNVS_seq_remove_all:vn { path } { }
  }
  \BNVS_tl_set_eq:ii { key_base } { key }
  \BNVS_seq_set_eq:vv { path_base } { path }
}
\BNVS_new:bpn { if_resolve_pop_kip:TTF } #1 #2 #3 {
  \BNVS_split_pop_left:vTF { key } {
    \BNVS_split_pop_left:vTF { id } {
      \BNVS_split_pop_left:vTF { path } {
        \BNVS_tl_if_blank:vTF { key } {
          #1
        } {
          \BNVS_if_resolve_pop_kip_complete:
          #2
        }
      } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_kip:TTF/2 }
      }
    } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_kip:TTF/1 }
    }
  } { #3 }
}
\BNVS_new:bpn { if_resolve_pop_complete_white:T } #1 {
  \BNVS_split_pop_left:vTF { n_incr } {
    \BNVS_split_pop_left:vTF { incr } {
      \BNVS_split_pop_left:vTF { post } {
        #1
      } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_complete_white:T/3 }
      }
    } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_complete_white:T/2 }
    }
  } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_complete_white:T/1 }
  }
}
\BNVS_new:bpn { if_resolve_pop_complete_black:T } #1 {
  \BNVS_split_pop_left:vTF { a } {
    \BNVS_split_pop_left:vTF { a } {
      \BNVS_split_pop_left:vTF { a } {
        \BNVS_split_pop_left:vTF { a } {
          \BNVS_split_pop_left:vTF { a } {
            \BNVS_split_pop_left:vTF { a } {
              #1
            } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_complete_black:T/6 }
            }
          } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_complete_black:T/5 }
          }
        } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_complete_black:T/4 }
        }
      } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_complete_black:T/3 }
      }
    } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_complete_black:T/2 }
    }
  } {
\BNVS_end_unreachable_return_false:n { if_resolve_pop_complete_black:T/1 }
  }
}
\BNVS_int_new:v { split }
\BNVS_new:bpn { kip_x_path_resolve_or_end_return_false:nT } #1 #2 {
  \BNVS_kip_x_path_resolve:TFF {
    #2
  } {
    \BNVS_end_return_false:x { Too~many~dotted~components:~#1 }
  } {
    \BNVS_end_return_false:x { Unknown~dotted~path:~#1 }
  }
}
\BNVS_new_conditional:bpnn { if_append:ni } #1 #2 { T, F, TF } {
  \BNVS_begin:
  \BNVS_if_resolve:niTF { #1 } { #2 } {
    \BNVS_end_tl_put_right:ii { #2 } { #2 }
    \prg_return_true:
  } {
    \BNVS_end:
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { if_resolve:ni } #1 #2 { T, F, TF } {
  \BNVS_call:TF {
    \BNVS_begin:
    \BNVS_set:bpn { if_resolve_warning:n } ##1 {
      \BNVS_warning:n { #1:~##1 }
      \BNVS_set:bpn { if_resolve_warning:n } {
        \use_none:n
      }
    }
  \BNVS_regex_split:inTF { split } { #1 } {
      \BNVS_set:bpn { if_resolve_end_return_true: } {
        \BNVS_if_resolve_round_ans:
        \BNVS_end_tl_set:ii { #2 } { ans }
        \prg_return_true:
      }
      \BNVS_set:bpn { if_resolve_round_ans: } { \BNVS_round_ans: }
      \BNVS_tl_clear:i { ans }
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_tl_clear:i { ans }
      \BNVS_round_ans:n { #1 }
      \BNVS_end_tl_set:ii { #2 } { ans }
      \prg_return_true:
    }
  } {
    \BNVS_error:n { TOO_MANY_NESTED_CALLS/Resolution }
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { if_append:ii } #1 #2 { T, F, TF } {
  \BNVS_tl_use:Ni \BNVS_if_append:niTF { #1 } { #2 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { if_resolve:ii } #1 #2 { T, F, TF } {
  \BNVS_tl_use:Ni \BNVS_if_resolve:niTF { #1 } { #2 } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return: } {
  \BNVS_split_pop_left:vTF { a } {
    \BNVS_tl_put_right:ii { ans } { a }
    \BNVS_if_resolve_pop_kip:TTF {
      \BNVS_if_resolve_pop_kip:TTF {
\BNVS_end_unreachable_return_false:n { if_resolve_loop_or_end_return:/3 }
      } {
        \BNVS_if_resolve_pop_complete_white:T {
          \BNVS_tl_if_blank:vTF { n_incr } {
            \BNVS_tl_if_blank:vTF { incr } {
              \BNVS_tl_if_blank:vTF { post } {
                \BNVS_if_resolve_kip_end_return_true:F {
                  \BNVS_path_pop_right:cTF { a } {
                    \BNVS_tl_use:Ni \str_case:nnF { a } {
{ n         } { \BNVS_use:b { if_resolve_loop_or_end_return[.n]: } }
{ length    } { \BNVS_use:b { if_resolve_loop_or_end_return[.length]: } }
{ last      } { \BNVS_use:b { if_resolve_loop_or_end_return[.last]:  } }
{ range     } { \BNVS_use:b { if_resolve_loop_or_end_return[.range]: } }
{ previous  } { \BNVS_use:b { if_resolve_loop_or_end_return[.previous]: } }
{ next      } { \BNVS_use:b { if_resolve_loop_or_end_return[.next]:  } }
{ reset     } { \BNVS_use:b { if_resolve_loop_or_end_return[.reset]: } }
{ reset_all } { \BNVS_use:b { if_resolve_loop_or_end_return[.reset_all]: } }
                    } {
\BNVS_use:b { if_resolve_loop_or_end_return[...<integer>]: }
                    }
                  } {
\BNVS_use:b { if_resolve_loop_or_end_return[...]: }
                  }
                }
              } {
\BNVS_use:b { if_resolve_loop_or_end_return[...++]: }
              }
            } {
              \BNVS_path_suffix:nTF { n } {
\BNVS_use:b { if_resolve_loop_or_end_return[...n+=...]: }
              } {
\BNVS_use:b { if_resolve_loop_or_end_return[...+=...]: }
              }
            }
          } {
\BNVS_use:b { if_resolve_loop_or_end_return[...++n]: }
          }
        }
      } {
\BNVS_end_unreachable_return_false:n { if_resolve_loop_or_end_return:/2 }
      }
    } {
      \BNVS_if_resolve_pop_complete_black:T {
        \BNVS_path_suffix:nTF { n } {
\BNVS_use:b { if_resolve_loop_or_end_return[++...n]: }
        } {
\BNVS_use:b { if_resolve_loop_or_end_return[++...]: }
        }
      }
    } {
      \BNVS_if_resolve_end_return_true:
    }
  } {
\BNVS_end_unreachable_return_false:n { if_resolve_loop_or_end_return:/1 }
  }
}
\BNVS_new:bpn { if_resolve_kip_loop_or_end_return_true:F } #1 {
  \BNVS_tl_set:vx { a } {
    \BNVS_tl_use:i { key } . \BNVS_seq_use:cn { path } { . }}
  \BNVS_v_resolve:vcTF { a } { a } {
    \BNVS_tl_put_right:ii { ans } { a }
    \BNVS_if_resolve_loop_or_end_return:
  } {
    \BNVS_V_resolve:vvTF { a } { a } {
      \BNVS_tl_put_right:ii { ans } { a }
      \BNVS_if_resolve_loop_or_end_return:
    } {
      #1
    }
  }
}
\BNVS_new_conditional:bpnn { tl_set_from_kp:cvv } #1 #2 #3 { T, F, TF } {
  \BNVS_seq_if_empty:iTF { #2 } {
    \BNVS_tl_set:vx { #1 } {
      \BNVS_tl_use:i { #2 } . \BNVS_seq_use:cn { #3 } { . }
    }
    \prg_return_true:
  } {
    \BNVS_tl_set_eq:ii { a } { key }
    \prg_return_false:
  }
}
\BNVS_new:bpn { tl_set_from_kp:cvv } #1 #2 #3 {
  \BNVS_tl_set_from_kp:cvvT { #1 } { #2 } { #3 } { }
}
\BNVS_new:bpn { if_resolve_kip_end_return_true:F } {
  \BNVS_seq_clear:i { b }
  \BNVS_seq_set_eq:vv { a } { path }
  \BNVS_if_resolve_kip_loop_or_end_return_true:F
}
\BNVS_new:bpn { end_return_error:n } #1 {
      \BNVS_error:n { #1 }
      \BNVS_end:
      \prg_return_false:
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[.n]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_base_resolve_n:
    \BNVS_n_index_append:vvvTF { key } { key_base } { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_end_return_error:n {
        Undefined~dotted~path
      }
    }
  }
}
\BNVS_new_conditional:bpnn { path_suffix:n } #1 { T, F, TF } {
  \BNVS_seq_get_right:ccTF { path } { a } {
    \BNVS_tl_if_eq:vnTF { a } { #1 } {
      \BNVS_seq_pop_right:ccT { path } { a } { }
      \prg_return_true:
    } {
      \prg_return_false:
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[.length]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_L_append:vcTF { key } { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n { NO~length }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[.last]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_Z_append:vcTF { key } { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_end_return_false:x { NO~last }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[.range]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_range_append:vcTF { key } { ans } {
      \BNVS_set:bpn { if_resolve_round_ans: } { \prg_do_nothing: }
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n { NO~range }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[.previous]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_previous_append:vcTF { key } { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n { NO~previous }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[.next]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_next_append:vcTF { key } { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n { NO~next }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[.reset]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_v_greset:vnT { key } { } { }
    \BNVS_V_append:vvTF { key } { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n { NO~reset }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[.reset_all]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_greset_all:vnT { key } { } { }
    \BNVS_V_append:vvTF { key } { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n { NO~reset }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[...<integer>]: } {
  \BNVS_path_resolve_n:TF {
    \BNVS_index_append:vvcTF { key } { a } { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n { NO~integer }
    }
  } {
    \BNVS_tl_put_right:in { ans } { -1+ }
    \BNVS_tl_put_right:ii { ans } { a }
    \BNVS_round_ans:
    \BNVS_if_resolve_end_return_true:
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[...]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_V_append:vvTF { key } { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n { NO~value }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[...++]: } {
  \BNVS_path_suffix:nTF { reset } {
    \BNVS_path_resolve_n:T {
      \BNVS_v_greset:vnT { key } { } { }
      \BNVS_v_post_append:vncTF { key } { 1 }  { ans } {
        \BNVS_if_resolve_loop_or_end_return:
      } {
        \BNVS_if_resolve_end_return_false:n { NO~post }
      }
    }
  } {
    \BNVS_path_suffix:nTF { reset_all } {
      \BNVS_path_resolve_n:T {
        \BNVS_greset_all:vnT { key } { } { }
        \BNVS_v_post_append:vncTF { key } { 1 }  { ans } {
          \BNVS_if_resolve_loop_or_end_return:
        } {
          \BNVS_if_resolve_end_return_false:n { NO~post }
        }
      }
    } {
      \BNVS_path_resolve_n:T {
        \BNVS_v_post_append:vncTF { key } { 1 }  { ans } {
          \BNVS_if_resolve_loop_or_end_return:
        } {
          \BNVS_if_resolve_end_return_false:n { NO~post }
        }
      }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[...n+=...]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_base_resolve_n:
    \BNVS_n_incr_append:vvvcTF { key } { key_base }  { incr }  { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n {
        NO~n~incrementation
      }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[...+=...]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_v_incr_append:vvcTF { key }  { incr }  { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n {
        NO~incremented~value
      }
    }
  }
}
\BNVS_new:bpn { base_resolve_n: } {
  \BNVS_seq_if_empty:iF { path_base } {
    \BNVS_seq_pop_right:cc { path_base } { a }
    \BNVS_seq_if_empty:iF { path_base } {
      \BNVS_tl_put_right:ix { key_base } {
        . \BNVS_seq_use:in { path_base } { . }
      }
    }
  }
}
\BNVS_new:bpn { base_resolve: } {
  \BNVS_seq_if_empty:iF { path_base } {
    \BNVS_tl_put_right:ix { key_base } {
      . \BNVS_seq_use:in { path_base } { . }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[...++n]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_base_resolve:
    \BNVS_n_incr_append:iiniTF { key } { key_base } { 1 }  { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n { NO~...++n }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[++...n]: } {
  \BNVS_path_resolve_n:T {
    \BNVS_base_resolve_n:
    \BNVS_n_incr_append:iiniTF { key } { key_base } { 1 }  { ans } {
      \BNVS_if_resolve_loop_or_end_return:
    } {
      \BNVS_if_resolve_end_return_false:n { NO~++...n }
    }
  }
}
\BNVS_new:bpn { if_resolve_loop_or_end_return[++...]: } {
  \BNVS_path_suffix:nTF { reset } {
    \BNVS_path_resolve_n:T {
      \BNVS_v_incr_append:iniTF { key } { 1 } { ans } {
        \BNVS_v_greset:vnT { key } { } { }
        \BNVS_if_resolve_loop_or_end_return:
      } {
        \BNVS_v_greset:vnT { key } { } { }
        \BNVS_if_resolve_end_return_false:n { No~increment }
      }
    }
  } {
    \BNVS_path_suffix:nTF { reset_all } {
      \BNVS_path_resolve_n:T {
        \BNVS_v_incr_append:iniTF { key } { 1 } { ans } {
          \BNVS_greset_all:vnT { key } { } { }
          \BNVS_if_resolve_loop_or_end_return:
        } {
          \BNVS_greset_all:vnT { key } { } { }
          \BNVS_if_resolve_end_return_false:n { No~increment }
        }
      }
    } {
      \BNVS_path_resolve_n:T {
        \BNVS_v_incr_append:iniTF { key } { 1 } { ans } {
          \BNVS_if_resolve_loop_or_end_return:
        } {
          \BNVS_if_resolve_end_return_false:n { No~increment }
        }
      }
    }
  }
}
\regex_const:Nn \c__bnvs_A_cln_Z_regex {
  \A \s* (?:
    ( [^:]+? )
    | ( [^:]+? ) \s* : (?: ( \s* [^:]*? ) | : ( \s* [^:]*? ) )
    | :: \s* (?: ( [^:]+? ) \s* : \s* ( [^:]+? ) )?
    | : \s* (?: ( [^:]+? ) \s* :: \s* ( [^:]*? ) )?
  )
  \s* \Z
}
\BNVS_new:bpn { query_eval_end_return_true: } {
  \group_end:
  \prg_return_true:
}
\BNVS_new:bpn { query_eval_end_return_false: } {
  \BNVS_end:
  \prg_return_false:
}
\BNVS_new:bpn { query_eval_end_return_false:n } #1 {
  \BNVS_end:
  \prg_return_false:
}
\BNVS_new:bpn { query_eval_error_end_return_false:n } #1 {
  \BNVS_error:x { #1 }
  \BNVS_query_eval_end_return_false:
}
\BNVS_new:bpn { query_eval_unreachable: } {
  \BNVS_query_eval_error_end_return_false:n { UNREACHABLE }
}
\BNVS_new_conditional:bpnn { query_eval_match_branch: } { T, F, TF } {
  \BNVS_match_pop_left:iT V {
    \BNVS_match_pop_left:iT V {
      \BNVS_tl_if_blank:vTF V {
        \BNVS_match_pop_left:iT A {
          \BNVS_match_pop_left:iT Z {
            \BNVS_match_pop_left:iT L {
              \BNVS_tl_if_blank:vTF A {
                \BNVS_match_pop_left:iT L {
                  \BNVS_match_pop_left:iT Z {
                    \BNVS_tl_if_blank:vTF Z {
                      \BNVS_tl_if_blank:vTF L {
                        \BNVS_match_pop_left:iT Z {
                          \BNVS_match_pop_left:iT L {
                            \BNVS_tl_if_blank:vTF L {
                              \BNVS_tl_if_blank:vTF Z {
                                \BNVS_use:b { query_eval_return[:]: }
                              } {
                                \BNVS_use:b { query_eval_return[:Z]: }
                              }
                            } {
                              \BNVS_tl_if_blank:vTF Z {
\BNVS_query_eval_error_end_return_false:n { Missing~first~or~last }
                              } {
                                \BNVS_use:b { query_eval_return[:Z::L]: }
                              }
                            }
                          }
                        }
                      } {
\BNVS_query_eval_error_end_return_false:n { Missing~first~or~last }
                      }
                    } {
                      \BNVS_tl_if_blank:vTF L {
                        \BNVS_query_eval_unreachable:
                      } {
                        \BNVS_use:b { query_eval_return[:Z::L]: }
                      }
                    }
                  }
                }
              } {
                \BNVS_tl_if_blank:vTF Z {
                  \BNVS_tl_if_blank:vTF L {
                    \BNVS_use:b { query_eval_return[A:]: }
                  } {
                    \BNVS_use:b { query_eval_return[A::L]: }
                  }
                } {
                  \BNVS_tl_if_blank:vTF L {
                    \BNVS_use:b { query_eval_return[A:Z]: }
                  } {
                    \BNVS_query_eval_error_end_return_false:n {
                      Only~two~of~first,~last~or~length
                    }
                  }
                }
              }
            }
          }
        }
      } {
        \BNVS_use:b { query_eval_return[V]: }
      }
    }
  }
}
\BNVS_new:bpn { query_eval_return[V]: } {
  \BNVS_if_resolve:iiTF { V } { ans } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new:bpn { query_eval_return[A:Z]: } {
  \BNVS_if_resolve:iiTF { A } { ans } {
    \BNVS_tl_put_right:in { ans } { - }
    \BNVS_if_append:iiTF { Z } { ans } {
      \prg_return_true:
    } {
      \prg_return_false:
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new:bpn { query_eval_return[A::L]: } {
  \BNVS_if_resolve:iiTF { A } { A } {
    \BNVS_if_resolve:iiTF { L } { ans } {
      \BNVS_tl_put_right:in { ans } { + }
      \BNVS_tl_put_right:ii { ans } { A }
      \BNVS_tl_put_right:in { ans } { -1 }
      \BNVS_round_ans:
      \BNVS_tl_put_left:in { ans } { - }
      \BNVS_tl_put_left:cv { ans } { A }
      \prg_return_true:
    } {
      \prg_return_false:
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new:bpn { query_eval_return[A:]: } {
  \BNVS_if_resolve:iiTF { A } { ans } {
    \BNVS_tl_put_right:in { ans } { - }
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new:bpn { query_eval_return[:Z::L]: } {
  \BNVS_if_resolve:iiTF { Z } { Z } {
    \BNVS_if_resolve:iiTF { L } { ans } {
      \BNVS_tl_put_left:in  { ans } { 1-}
      \BNVS_tl_put_right:in { ans } { + }
      \BNVS_tl_put_right:ii { ans } { Z }
      \BNVS_round_ans:
      \BNVS_tl_put_right:in { ans } { - }
      \BNVS_tl_put_right:ii { ans } { Z }
      \prg_return_true:
    } {
      \prg_return_false:
    }
  } {
    \prg_return_false:
  }
}
\BNVS_new:bpn { query_eval_return[:]: } {
  \BNVS_tl_set:in { ans } { - }
  \prg_return_true:
}
\BNVS_new:bpn { query_eval_return[:Z]: } {
  \BNVS_tl_set:in { ans } { - }
  \BNVS_if_append:iiTF { Z } { ans } {
    \prg_return_true:
  } {
    \prg_return_false:
  }
}
\BNVS_new_conditional:bpnn { query_eval:in } #1 #2 { T, F, TF } {
  \BNVS_call_greset:
  \BNVS_extract_once:inTF { A_cln_Z } { #2 } {
    \BNVS_begin:
    \BNVS_query_eval_match_branch:TF {
      \BNVS_end_tl_set:ii { #1 } { ans }
      \prg_return_true:
    } {
      \BNVS_end:
      \prg_return_false:
    }
  } {
    \BNVS_error:n { Syntax~error:~#2 }
    \prg_return_false:
  }
}
\regex_const:Nn \c__bnvs_comma_regex { \s* , \s* }
\BNVS_new:bpn { eval:in } #1 #2 {
  \BNVS_begin:
  \BNVS_seq_clear:i { query }
  \BNVS_seq_clear:i { ans }
  \regex_split:NnN \c__bnvs_comma_regex { #2 } \l__bnvs_query_seq
  \BNVS_seq_map_inline:in { query } {
    \BNVS_tl_clear:i { ans }
    \BNVS_query_eval:inTF { ans } { ##1 } {
      \BNVS_seq_put_right:ii { ans } { ans }
    } {
      \seq_map_break:n {
        \BNVS_error:n { Circular/Undefined~dependency~in~#2}
      }
    }
  }
  \BNVS_seq_use:nin {
    \BNVS_end: \BNVS_tl_put_right:in { #1 }
  } { ans } ,
}
\NewDocumentCommand \BeanovesEval { O{} m } {
  \BNVS_begin:
  \keys_define:nn { BeanovesEval } {
    in:N .tl_set:N = \l__bnvs_BeanovesEval_tl,
    in:N .initial:n = { },
    see .bool_set:N = \l__bnvs_BeanovesEval_bool,
    see .default:n = true,
    see .initial:n = false,
  }
  \keys_set:nn { BeanovesEval } { #1 }
  \BNVS_tl_clear:i { ans }
  \BNVS_eval:in { ans } { #2 }
  \BNVS_tl_if_empty:iTF { BeanovesEval } {
    \BNVS_bool_if:iTF { BeanovesEval } {
      \BNVS_tl_use_n:Ni \BNVS_end: { ans }
    } {
      \BNVS_end:
    }
  } {
    \BNVS_bool_if:iTF { BeanovesEval } {
      \cs_set:Npn \BNVS_end:Nn ##1 ##2 {
        \BNVS_end:
        \tl_set:Nn ##1 { ##2 }
        ##2
      }
    } {
      \cs_set:Npn \BNVS_end:Nn ##1 ##2 {
        \BNVS_end:
        \tl_set:Nn ##1 { ##2 }
      }
    }
    \BNVS_tl_use:ni {
      \BNVS_tl_use:Ni \BNVS_end:Nn { BeanovesEval }
    } { ans }
  }
}
\NewDocumentCommand \BeanovesReset { s O{} m } {
  \BNVS_name_id_n_get:nTF { #3 } {
    \BNVS_tl_use:ni {
      \IfBooleanTF { #1 } {
        \BNVS_greset_all:nnF
      } {
        \BNVS_v_greset:nnF
      }
    } { key } { #2 } {
    }
  } {
    \BNVS_warning:n { Bad~name:~#3 }
  }
  \ignorespaces
}
\makeatother
\ExplSyntaxOff
%% 
%% beanoves --- beamer named overlay specifications
%% 
%% Copyright (C) 2023 by Jérôme LAURENS <jerome.laurens@u-bourgogne.fr>
%% 
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License (LPPL), either
%% version 1.3c of this license or (at your option) any later
%% version.  The latest version of this license is in the file:
%% 
%% https://www.latex-project.org/lppl.txt
%% 
%% This work is "maintained" (as per LPPL maintenance status) by
%% Jérôme LAURENS.
%% 
%% This work consists of the file  beanoves.dtx
%% and the derived files           beanoves.ins,
%%                                 beanoves.pdf,
%%                                 beanoves.sty and
%%                                 beanoves-debug.sty.
%% 
%%
%% End of file `beanoves.sty'.
